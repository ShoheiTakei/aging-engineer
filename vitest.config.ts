/**
 * Vitestè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
 *
 * é–¢é€£æ–‡æ›¸:
 * - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ: docs/design/frontend-test-infra/architecture.md
 * - ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³: docs/design/frontend-test-infra/test-patterns.md
 *
 * ä¿¡é ¼æ€§: ğŸ”µ Vitestå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€Astroãƒ†ã‚¹ãƒˆãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«åŸºã¥ã
 */

import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    // ========================================
    // ãƒ†ã‚¹ãƒˆç’°å¢ƒè¨­å®š
    // ========================================

    /**
     * DOMç’°å¢ƒ
     * - happy-dom: è»½é‡ãƒ»é«˜é€Ÿï¼ˆæ¨å¥¨ï¼‰
     * - jsdom: ã‚ˆã‚Šå®Œå…¨ãªDOMå®Ÿè£…ï¼ˆäº’æ›æ€§ãŒå¿…è¦ãªå ´åˆï¼‰
     */
    environment: 'happy-dom',

    /**
     * ã‚°ãƒ­ãƒ¼ãƒãƒ«API
     * describe, it, expectç­‰ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆãªã—ã§ä½¿ç”¨å¯èƒ½
     */
    globals: true,

    // ========================================
    // ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«è¨­å®š
    // ========================================

    /**
     * ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
     * - srcé…ä¸‹ã® .test.ts ãƒ•ã‚¡ã‚¤ãƒ«: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ†ã‚¹ãƒˆï¼ˆã‚³ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
     * - tests ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã® .test.ts ãƒ•ã‚¡ã‚¤ãƒ«: å˜ä½“ãƒ†ã‚¹ãƒˆãƒ»ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ†ã‚¹ãƒˆ
     * - __tests__ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«: Jestäº’æ›ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
     */
    include: [
      'src/**/*.test.ts',
      'src/**/*.test.tsx',
      'tests/**/*.test.ts',
      'tests/**/*.test.tsx',
      '**/__tests__/**/*',
    ],

    /**
     * é™¤å¤–ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
     */
    exclude: [
      'node_modules',
      'dist',
      '.astro',
      'tests/e2e/**/*', // E2Eãƒ†ã‚¹ãƒˆã¯Playwrightã§å®Ÿè¡Œ
      'tests/fixtures/**/*', // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
    ],

    // ========================================
    // ä¸¦åˆ—å®Ÿè¡Œè¨­å®š
    // ========================================

    /**
     * ä¸¦åˆ—å®Ÿè¡Œã®æœ‰åŠ¹åŒ–
     * - pool: threadsï¼ˆæ¨å¥¨ã€é«˜é€Ÿï¼‰
     * - poolOptions: ä¸¦åˆ—å®Ÿè¡Œã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
     */
    pool: 'threads',
    poolOptions: {
      threads: {
        singleThread: false, // ä¸¦åˆ—å®Ÿè¡Œã‚’æœ‰åŠ¹åŒ–
      },
    },

    /**
     * ãƒ†ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
     * å„ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
     */
    testTimeout: 10000,

    // ========================================
    // ã‚«ãƒãƒ¬ãƒƒã‚¸è¨­å®š
    // ========================================

    coverage: {
      /**
       * ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ—ãƒ­ãƒã‚¤ãƒ€
       * - v8: é«˜é€Ÿã€Viteã¨ã®çµ±åˆãŒè‰¯ã„ï¼ˆæ¨å¥¨ï¼‰
       * - istanbul: ã‚ˆã‚Šè©³ç´°ãªã‚«ãƒãƒ¬ãƒƒã‚¸
       */
      provider: 'v8',

      /**
       * ã‚«ãƒãƒ¬ãƒƒã‚¸å¯¾è±¡
       */
      include: ['src/**/*.ts', 'src/**/*.tsx', 'src/**/*.astro'],

      /**
       * ã‚«ãƒãƒ¬ãƒƒã‚¸é™¤å¤–
       */
      exclude: [
        'src/**/*.test.ts',
        'src/**/*.spec.ts',
        'src/**/*.d.ts',
        'src/env.d.ts',
        'src/**/__tests__/**',
      ],

      /**
       * ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆå½¢å¼
       * - text: ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«è¡¨ç¤º
       * - html: coverage/index.html ã«è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ
       * - json: coverage/coverage-final.json ã«JSONå½¢å¼
       * - lcov: CI/CDãƒ„ãƒ¼ãƒ«ï¼ˆCodecovç­‰ï¼‰ç”¨
       */
      reporter: ['text', 'html', 'json', 'lcov'],

      /**
       * ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ï¼ˆå“è³ªåŸºæº–ï¼‰
       * tech-stack.mdã®ã€Œãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: 80%ä»¥ä¸Šã€ã«æº–æ‹ 
       */
      thresholds: {
        lines: 80,
        functions: 80,
        branches: 75,
        statements: 80,
      },

      /**
       * ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›å…ˆ
       */
      reportsDirectory: './coverage',
    },

    // ========================================
    // ãƒ¢ãƒƒã‚¯è¨­å®š
    // ========================================

    /**
     * setupãƒ•ã‚¡ã‚¤ãƒ«
     * ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã«èª­ã¿è¾¼ã‚€ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«
     */
    // setupFiles: ['./tests/setup.ts'],

    /**
     * ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
     * ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Ÿè¡Œå‰ã«1åº¦ã ã‘å®Ÿè¡Œ
     */
    // globalSetup: './tests/globalSetup.ts',

    // ========================================
    // ãƒ¬ãƒãƒ¼ãƒˆè¨­å®š
    // ========================================

    /**
     * ãƒ¬ãƒãƒ¼ã‚¿ãƒ¼
     * - default: æ¨™æº–å‡ºåŠ›
     * - verbose: è©³ç´°å‡ºåŠ›
     * - dot: ã‚·ãƒ³ãƒ—ãƒ«ãªé€²æ—è¡¨ç¤º
     * - json: JSONå½¢å¼ï¼ˆCI/CDç”¨ï¼‰
     * - junit: JUnit XMLå½¢å¼ï¼ˆCI/CDç”¨ï¼‰
     */
    reporters: ['default'],

    // ========================================
    // ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰è¨­å®š
    // ========================================

    /**
     * ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦–é™¤å¤–
     */
    watchExclude: [
      'node_modules/**',
      'dist/**',
      '.astro/**',
      'coverage/**',
      'test-results/**',
    ],
  },

  // ========================================
  // Viteè¨­å®šï¼ˆãƒ‘ã‚¹è§£æ±ºç­‰ï¼‰
  // ========================================

  resolve: {
    alias: {
      '@': '/src',
      '@/components': '/src/components',
      '@/layouts': '/src/layouts',
      '@/utils': '/src/utils',
      '@/content': '/src/content',
    },
  },

  // ========================================
  // ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
  // ========================================

  define: {
    'import.meta.env.PUBLIC_R2_URL': JSON.stringify(
      process.env.PUBLIC_R2_URL || 'https://test-r2-url.com',
    ),
  },
});
