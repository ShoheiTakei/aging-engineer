/**
 * ç›®æ¬¡ç”Ÿæˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 *
 * é–¢é€£è¦ä»¶:
 * - REQ-901: è¨˜äº‹ã®è¦‹å‡ºã—ï¼ˆh2, h3ï¼‰ã‹ã‚‰ç›®æ¬¡ã‚’è‡ªå‹•ç”Ÿæˆ
 * - REQ-112: è¨˜äº‹è©³ç´°ãƒšãƒ¼ã‚¸ã§ç›®æ¬¡ã‚’è¡¨ç¤º
 * - EDGE-104: è¦‹å‡ºã—ãŒå­˜åœ¨ã—ãªã„è¨˜äº‹ã¯ã€ç›®æ¬¡ã‚’è¡¨ç¤ºã—ãªã„ã‚ˆã†ã«ã™ã‚‹
 *
 * é–¢é€£æ–‡æ›¸:
 * - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å®šç¾©æ›¸: docs/implements/blog-article-management/TASK-0008/toc-utils-testcases.md
 * - è¦ä»¶å®šç¾©æ›¸: docs/implements/blog-article-management/TASK-0008/toc-utils-requirements.md
 * - ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼: docs/design/blog-article-management/dataflow.md
 */

// ========================================
// å‹å®šç¾©
// ========================================

/**
 * ã€å‹å®šç¾©ã€‘: Astroã®render()ãƒ¡ã‚½ãƒƒãƒ‰ãŒè¿”ã™headingsé…åˆ—ã®è¦ç´ å‹
 * ã€å‚ç…§å…ƒã€‘: Astroå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
 * ğŸ”µ ä¿¡é ¼æ€§: Astroå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚ˆã‚Š
 */
export interface MarkdownHeading {
  /** è¦‹å‡ºã—ãƒ¬ãƒ™ãƒ« (1-6) */
  depth: number;
  /** ã‚¢ãƒ³ã‚«ãƒ¼ID */
  slug: string;
  /** è¦‹å‡ºã—ãƒ†ã‚­ã‚¹ãƒˆ */
  text: string;
}

/**
 * ã€å‹å®šç¾©ã€‘: ç›®æ¬¡ã®å„é …ç›®ã‚’è¡¨ã™å‹
 * ğŸ”µ ä¿¡é ¼æ€§: è¦ä»¶å®šç¾©æ›¸ã‚ˆã‚Š
 */
export interface TOCItem {
  /** è¦‹å‡ºã—ãƒ¬ãƒ™ãƒ« (2 or 3) */
  depth: number;
  /** ã‚¢ãƒ³ã‚«ãƒ¼ãƒªãƒ³ã‚¯ç”¨ID */
  slug: string;
  /** è¦‹å‡ºã—ãƒ†ã‚­ã‚¹ãƒˆ */
  text: string;
  /** å­é …ç›®ï¼ˆh3ãŒh2ã®ä¸‹ã«é…ç½®ï¼‰ */
  children: TOCItem[];
}

/**
 * ã€å‹å®šç¾©ã€‘: generateTOCé–¢æ•°ã®æˆ»ã‚Šå€¤
 * ğŸ”µ ä¿¡é ¼æ€§: è¦ä»¶å®šç¾©æ›¸ã‚ˆã‚Š
 */
export interface TOCResult {
  /** ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã®ç›®æ¬¡é …ç›® */
  items: TOCItem[];
  /** ç›®æ¬¡ãŒã‚ã‚‹ã‹ï¼ˆh2/h3ãŒå­˜åœ¨ã™ã‚‹ã‹ï¼‰ */
  hasContent: boolean;
}

// ========================================
// å®šæ•°å®šç¾©
// ========================================

/**
 * ã€è¨­å®šå®šæ•°ã€‘: ç›®æ¬¡ã«å«ã‚ã‚‹è¦‹å‡ºã—ãƒ¬ãƒ™ãƒ« ğŸ”µ
 * ã€ç”¨é€”ã€‘: h2, h3ã®ã¿ã‚’ç›®æ¬¡å¯¾è±¡ã¨ã™ã‚‹
 * ã€èª¿æ•´å¯èƒ½æ€§ã€‘: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚€æ‹¡å¼µãŒå¯èƒ½
 */
const TOC_HEADING_LEVELS = [2, 3] as const;

/**
 * ã€è¨­å®šå®šæ•°ã€‘: ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã®è¦‹å‡ºã—ãƒ¬ãƒ™ãƒ« ğŸ”µ
 * ã€ç”¨é€”ã€‘: h2ã‚’ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã¨ã—ã¦æ‰±ã†
 */
const TOP_LEVEL_DEPTH = 2;

// ========================================
// ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
// ========================================

/**
 * ã€ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã€‘: è¦‹å‡ºã—ãŒTOCå¯¾è±¡ã‹ã©ã†ã‹ã‚’åˆ¤å®š
 * ã€å˜ä¸€è²¬ä»»ã€‘: h2/h3ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’æ‹…å½“
 * ğŸ”µ ä¿¡é ¼æ€§: è¦ä»¶å®šç¾©æ›¸REQ-901ã‚ˆã‚Š
 *
 * @param heading - åˆ¤å®šå¯¾è±¡ã®è¦‹å‡ºã—
 * @returns h2ã¾ãŸã¯h3ã®å ´åˆtrue
 */
function isTOCHeading(heading: MarkdownHeading): boolean {
  return TOC_HEADING_LEVELS.includes(heading.depth as 2 | 3);
}

/**
 * ã€ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã€‘: MarkdownHeadingã‚’TOCItemã«å¤‰æ›
 * ã€å˜ä¸€è²¬ä»»ã€‘: ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å¤‰æ›ã‚’æ‹…å½“
 * ğŸ”µ ä¿¡é ¼æ€§: è¦ä»¶å®šç¾©æ›¸ã‚ˆã‚Š
 *
 * @param heading - å¤‰æ›å¯¾è±¡ã®è¦‹å‡ºã—
 * @returns TOCItemï¼ˆå­è¦ç´ ã¯ç©ºé…åˆ—ã§åˆæœŸåŒ–ï¼‰
 */
function toTOCItem(heading: MarkdownHeading): TOCItem {
  return {
    depth: heading.depth,
    slug: heading.slug,
    text: heading.text,
    children: [],
  };
}

// ========================================
// å…¬é–‹é–¢æ•°
// ========================================

/**
 * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: Markdownã®è¦‹å‡ºã—é…åˆ—ã‹ã‚‰ç›®æ¬¡ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ç”Ÿæˆã™ã‚‹
 * ã€è¨­è¨ˆæ–¹é‡ã€‘: h2ã‚’ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã€h3ã‚’ãã®å­è¦ç´ ã¨ã—ã¦éšå±¤æ§‹é€ ã‚’æ§‹ç¯‰
 * ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: O(n)ã®æ™‚é–“è¨ˆç®—é‡ï¼ˆnã¯è¦‹å‡ºã—æ•°ï¼‰
 * ã€ä¿å®ˆæ€§ã€‘: ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã®åˆ†é›¢ã«ã‚ˆã‚Šå¤‰æ›´å®¹æ˜“æ€§ã‚’ç¢ºä¿
 * ã€ãƒ†ã‚¹ãƒˆå¯¾å¿œã€‘: TC-TOC-001ã€œTC-TOC-204ï¼ˆæ­£å¸¸ç³»ãƒ»ç•°å¸¸ç³»ãƒ»å¢ƒç•Œå€¤ï¼‰
 * ğŸ”µ ä¿¡é ¼æ€§: dataflow.mdã®ç›®æ¬¡ç”Ÿæˆãƒ•ãƒ­ãƒ¼ã«åŸºã¥ã
 *
 * @param headings - Astroã®render()ãƒ¡ã‚½ãƒƒãƒ‰ãŒè¿”ã™headingsé…åˆ—
 * @returns TOCResultï¼ˆç›®æ¬¡ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æœ‰ç„¡ãƒ•ãƒ©ã‚°ï¼‰
 *
 * @example
 * const { Content, headings } = await post.render();
 * const toc = generateTOC(headings);
 * if (toc.hasContent) {
 *   // ç›®æ¬¡ã‚’è¡¨ç¤º
 * }
 *
 * @é–¢é€£è¦ä»¶ REQ-901, REQ-112, EDGE-104
 */
export function generateTOC(headings: MarkdownHeading[]): TOCResult {
  // ã€Step 1ã€‘: h2/h3ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° ğŸ”µ
  // ã€ç›®çš„ã€‘: h1, h4-h6ã¯ç›®æ¬¡å¯¾è±¡å¤–ã¨ã™ã‚‹ï¼ˆREQ-901ï¼‰
  const tocHeadings = headings.filter(isTOCHeading);

  // ã€Step 2ã€‘: ç©ºãƒã‚§ãƒƒã‚¯ï¼ˆEDGE-104å¯¾å¿œï¼‰ ğŸ”µ
  // ã€ç›®çš„ã€‘: è¦‹å‡ºã—ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç›®æ¬¡ã‚’è¡¨ç¤ºã—ãªã„
  if (tocHeadings.length === 0) {
    return {
      items: [],
      hasContent: false,
    };
  }

  // ã€Step 3ã€‘: éšå±¤æ§‹é€ ã®æ§‹ç¯‰ ğŸ”µ
  // ã€ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã€‘:
  //   - h2ãŒæ¥ãŸã‚‰ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã«è¿½åŠ 
  //   - h3ãŒæ¥ãŸã‚‰ç›´å‰ã®h2ã®å­ã«è¿½åŠ 
  //   - h3ãŒå…ˆã«æ¥ãŸå ´åˆã¯ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã«è¿½åŠ ï¼ˆè¦ªãªã—h3ï¼‰
  const items: TOCItem[] = [];
  let currentParent: TOCItem | null = null;

  for (const heading of tocHeadings) {
    const tocItem = toTOCItem(heading);

    if (heading.depth === TOP_LEVEL_DEPTH) {
      // ã€h2ã®å‡¦ç†ã€‘: ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã«è¿½åŠ ã—ã€currentParentã‚’æ›´æ–°
      items.push(tocItem);
      currentParent = tocItem;
    } else {
      // ã€h3ã®å‡¦ç†ã€‘: è¦ªh2ãŒã‚ã‚Œã°ãã®å­ã«ã€ãªã‘ã‚Œã°ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã«è¿½åŠ 
      if (currentParent !== null) {
        currentParent.children.push(tocItem);
      } else {
        // ã€è¦ªãªã—h3ã€‘: ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã¨ã—ã¦æ‰±ã†ï¼ˆEDGE-TOC-003å¯¾å¿œï¼‰
        items.push(tocItem);
      }
    }
  }

  // ã€Step 4ã€‘: çµæœã‚’è¿”ã™ ğŸ”µ
  return {
    items,
    hasContent: true,
  };
}
