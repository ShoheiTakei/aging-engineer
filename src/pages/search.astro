---
/**
 * Search - æ¤œç´¢ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
 *
 * TASK-0019: æ¤œç´¢ãƒšãƒ¼ã‚¸ã®å®Ÿè£…
 *
 * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰æ¤œç´¢æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹æ¤œç´¢ãƒšãƒ¼ã‚¸
 * ã€å®Ÿè£…æ–¹é‡ã€‘: ãƒ“ãƒ«ãƒ‰æ™‚ã«æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹JSONã‚’ç”Ÿæˆã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œç´¢
 * ã€è¨­è¨ˆæ–¹é‡ã€‘: Islands Architectureæ´»ç”¨ã€æœ€å°é™ã®JavaScriptã§é«˜ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å®Ÿç¾
 * ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯é…å»¶ãƒ­ãƒ¼ãƒ‰ã€debounceå‡¦ç†ã§APIã‚³ãƒ¼ãƒ«æœ€å°åŒ–
 *
 * é–¢é€£è¦ä»¶:
 * - REQ-401: è¨˜äº‹æ¤œç´¢æ©Ÿèƒ½ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãƒ»æœ¬æ–‡ã‹ã‚‰å…¨æ–‡æ¤œç´¢ã€éƒ¨åˆ†ä¸€è‡´ï¼‰
 * - REQ-402: æ¤œç´¢çµæœã‚’é–¢é€£åº¦é †ã«è¡¨ç¤º
 * - NFR-301: ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯HTMLä½¿ç”¨
 * - NFR-302: ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ
 * - NFR-303: ARIAãƒ©ãƒ™ãƒ«é©åˆ‡ãªè¨­å®š
 * - NFR-304: ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¯è¦–åŒ–
 * - EDGE-101: æ¤œç´¢çµæœ0ä»¶ã®å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
 *
 * é–¢é€£æ–‡æ›¸:
 * - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ: docs/design/blog-article-management/architecture.md
 * - ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼: docs/design/blog-article-management/dataflow.md
 */

import { getCollection } from 'astro:content';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import BaseLayout from '../layouts/BaseLayout.astro';
import { generateSearchIndex } from '../utils/search';

// ========================================
// æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç”Ÿæˆï¼ˆãƒ“ãƒ«ãƒ‰æ™‚ï¼‰
// ========================================

/**
 * ãƒ–ãƒ­ã‚°è¨˜äº‹ã‚’å–å¾—ã—ã€æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç”Ÿæˆ
 * ä¸‹æ›¸ãè¨˜äº‹ã¯é™¤å¤–
 */
const allPosts = await getCollection('blog', ({ data }) => !data.draft);

/**
 * æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç”Ÿæˆ
 * - ãƒ“ãƒ«ãƒ‰æ™‚ã«å®Ÿè¡Œã•ã‚Œã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã«æ¸¡ã•ã‚Œã‚‹
 * - æœ¬æ–‡ã¯500æ–‡å­—ã«åˆ¶é™ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼‰
 */
const searchIndex = generateSearchIndex(
  allPosts.map((post) => ({
    slug: post.id,
    data: post.data,
    body: post.body || '',
  })),
  { bodyLength: 500 },
);

// æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’JSONæ–‡å­—åˆ—ã«å¤‰æ›
const searchIndexJson = JSON.stringify(searchIndex);

// ãƒšãƒ¼ã‚¸ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
const pageTitle = 'è¨˜äº‹æ¤œç´¢ | Aging Engineer Blog';
const pageDescription = 'ãƒ–ãƒ­ã‚°è¨˜äº‹ã‚’å…¨æ–‡æ¤œç´¢ã§ãã¾ã™ã€‚ã‚¿ã‚¤ãƒˆãƒ«ã€æœ¬æ–‡ã€ã‚¿ã‚°ã‹ã‚‰æ¤œç´¢ãŒå¯èƒ½ã§ã™ã€‚';
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <Header siteTitle="Aging Engineer Blog" currentPath="/search" />

  <main class="container-wide py-8">
    <!--
      ã€æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã€‘
      æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã¨æ¤œç´¢çµæœã‚’å«ã‚€ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
      ğŸ”µ ä¿¡é ¼æ€§: REQ-401ã€NFR-301ã«åŸºã¥ãå®Ÿè£…
    -->
    <section aria-labelledby="search-heading" class="max-w-3xl mx-auto">
      <!--
        ã€ãƒšãƒ¼ã‚¸è¦‹å‡ºã—ã€‘
        h1ã‚¿ã‚°ã§ãƒšãƒ¼ã‚¸ã®ä¸»é¡Œã‚’æ˜ç¤ºï¼ˆSEOãƒ»ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œï¼‰
        ğŸ”µ ä¿¡é ¼æ€§: NFR-301ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯HTML
      -->
      <h1
        id="search-heading"
        class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-6"
      >
        è¨˜äº‹æ¤œç´¢
      </h1>

      <!--
        ã€æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã€‘
        - role="search": æ¤œç´¢ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‚’æ˜ç¤º
        - aria-label: ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼ç”¨ã®èª¬æ˜
        ğŸ”µ ä¿¡é ¼æ€§: NFR-301ã€NFR-303ã«åŸºã¥ãå®Ÿè£…
      -->
      <form role="search" aria-label="è¨˜äº‹ã‚’æ¤œç´¢" class="mb-8">
        <div class="relative">
          <!--
            ã€æ¤œç´¢å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã€‘
            - type="search": æ¤œç´¢å…¥åŠ›ã§ã‚ã‚‹ã“ã¨ã‚’æ˜ç¤º
            - aria-label: ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œ
            - aria-describedby: å…¥åŠ›ãƒ’ãƒ³ãƒˆã¸ã®å‚ç…§
            ğŸ”µ ä¿¡é ¼æ€§: NFR-302ã€NFR-303ã€NFR-304ã«åŸºã¥ãå®Ÿè£…
          -->
          <input
            type="search"
            id="search-input"
            name="q"
            placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›..."
            aria-label="æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰"
            aria-describedby="search-hint"
            class="w-full px-4 py-3 pl-12 text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2 placeholder-gray-500 dark:placeholder-gray-400"
          />
          <!--
            ã€æ¤œç´¢ã‚¢ã‚¤ã‚³ãƒ³ã€‘
            è£…é£¾çš„ãªSVGã‚¢ã‚¤ã‚³ãƒ³ï¼ˆaria-hidden="true"ã§ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼ã‹ã‚‰é™¤å¤–ï¼‰
          -->
          <svg
            class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"
            aria-hidden="true"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
            />
          </svg>
        </div>
        <!--
          ã€å…¥åŠ›ãƒ’ãƒ³ãƒˆã€‘
          æ¤œç´¢ã®ä½¿ã„æ–¹ã‚’èª¬æ˜ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ
          ğŸ”µ ä¿¡é ¼æ€§: ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š
        -->
        <p
          id="search-hint"
          class="mt-2 text-sm text-gray-600 dark:text-gray-400"
        >
          ã‚¿ã‚¤ãƒˆãƒ«ã€æœ¬æ–‡ã€ã‚¿ã‚°ã‹ã‚‰æ¤œç´¢ã§ãã¾ã™
        </p>
      </form>

      <!--
        ã€æ¤œç´¢çµæœã‚¨ãƒªã‚¢ã€‘
        - aria-live="polite": æ¤œç´¢çµæœã®å¤‰æ›´ã‚’ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼ã«é€šçŸ¥
        - aria-atomic="true": å¤‰æ›´æ™‚ã«å…¨ä½“ã‚’èª­ã¿ä¸Šã’
        ğŸ”µ ä¿¡é ¼æ€§: NFR-303ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œ
      -->
      <div
        id="search-results"
        aria-live="polite"
        aria-atomic="true"
        role="region"
        aria-label="æ¤œç´¢çµæœ"
      >
        <!--
          ã€åˆæœŸçŠ¶æ…‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€‘
          æ¤œç´¢å‰ã®æ¡ˆå†…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        -->
        <p
          id="initial-message"
          class="text-center text-gray-600 dark:text-gray-400 py-8"
        >
          æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
        </p>

        <!--
          ã€æ¤œç´¢çµæœãƒªã‚¹ãƒˆã€‘
          æ¤œç´¢çµæœãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´æ‰€ï¼ˆåˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤ºï¼‰
        -->
        <ul
          id="results-list"
          class="space-y-4 hidden"
          aria-label="æ¤œç´¢çµæœä¸€è¦§"
        >
        </ul>

        <!--
          ã€çµæœãªã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€‘
          æ¤œç´¢çµæœãŒ0ä»¶ã®å ´åˆã«è¡¨ç¤ºï¼ˆåˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤ºï¼‰
          ğŸ”µ ä¿¡é ¼æ€§: EDGE-101å¯¾å¿œ
        -->
        <p
          id="no-results"
          class="text-center text-gray-600 dark:text-gray-400 py-8 hidden"
        >
          è©²å½“ã™ã‚‹è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ
        </p>

        <!--
          ã€æ¤œç´¢ä¸­ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã€‘
          æ¤œç´¢å‡¦ç†ä¸­ã«è¡¨ç¤ºï¼ˆåˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤ºï¼‰
        -->
        <p
          id="loading-indicator"
          class="text-center text-gray-600 dark:text-gray-400 py-8 hidden"
        >
          æ¤œç´¢ä¸­...
        </p>
      </div>
    </section>
  </main>

  <Footer siteName="Aging Engineer Blog" />
</BaseLayout>

<!--
  ã€æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿ã€‘
  ãƒ“ãƒ«ãƒ‰æ™‚ã«ç”Ÿæˆã•ã‚ŒãŸæ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«åŸ‹ã‚è¾¼ã¿
  type="application/json"ã§ãƒ‘ãƒ¼ã‚¹å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ ¼ç´
-->
<script
  id="search-index-data"
  type="application/json"
  set:html={searchIndexJson}
/>

<!--
  ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰æ¤œç´¢ã‚¹ã‚¯ãƒªãƒ—ãƒˆã€‘
  is:inlineå±æ€§ã§ãƒãƒ³ãƒ‰ãƒ«ã›ãšãã®ã¾ã¾å‡ºåŠ›ï¼ˆè»½é‡åŒ–ï¼‰
  ğŸ”µ ä¿¡é ¼æ€§: REQ-401ã€REQ-402ã«åŸºã¥ãå®Ÿè£…
-->
<script is:inline>
  // ========================================
  // å‹å®šç¾©ï¼ˆJSDocã‚³ãƒ¡ãƒ³ãƒˆå½¢å¼ï¼‰
  // ========================================

  /**
   * @typedef {Object} SearchIndexItem
   * @property {string} slug - è¨˜äº‹ã®slug
   * @property {string} title - è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«
   * @property {string} description - è¨˜äº‹èª¬æ˜
   * @property {string} body - æœ¬æ–‡ï¼ˆåˆ‡ã‚Šè©°ã‚æ¸ˆã¿ï¼‰
   * @property {string[]} tags - ã‚¿ã‚°é…åˆ—
   * @property {string} pubDate - å…¬é–‹æ—¥ï¼ˆISO 8601å½¢å¼ï¼‰
   */

  /**
   * @typedef {Object} MatchInfo
   * @property {'title' | 'description' | 'body' | 'tags'} field - ãƒãƒƒãƒã—ãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
   * @property {Array<[number, number]>} indices - ãƒãƒƒãƒä½ç½®
   */

  /**
   * @typedef {Object} SearchResult
   * @property {SearchIndexItem} item - ãƒãƒƒãƒã—ãŸã‚¢ã‚¤ãƒ†ãƒ 
   * @property {number} score - é–¢é€£åº¦ã‚¹ã‚³ã‚¢
   * @property {MatchInfo[]} matches - ãƒãƒƒãƒç®‡æ‰€æƒ…å ±
   */

  // ========================================
  // å®šæ•°å®šç¾©
  // ========================================

  /** æ¤œç´¢ã®debounceæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰ */
  const DEBOUNCE_DELAY = 200;

  /** ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã®é‡ã¿ä»˜ã‘ */
  const SCORE_WEIGHTS = {
    title: 10,
    tags: 8,
    description: 5,
    body: 1,
  };

  // ========================================
  // DOMè¦ç´ ã®å–å¾—
  // ========================================

  /** @type {HTMLInputElement} */
  const searchInput = document.getElementById('search-input');
  const resultsList = document.getElementById('results-list');
  const noResults = document.getElementById('no-results');
  const initialMessage = document.getElementById('initial-message');
  const loadingIndicator = document.getElementById('loading-indicator');

  // ========================================
  // æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®èª­ã¿è¾¼ã¿
  // ========================================

  /** @type {SearchIndexItem[]} */
  let searchIndex = [];

  try {
    const indexData = document.getElementById('search-index-data');
    if (indexData) {
      searchIndex = JSON.parse(indexData.textContent || '[]');
    }
  } catch (error) {
    console.error('æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
  }

  // ========================================
  // æ¤œç´¢é–¢æ•°
  // ========================================

  /**
   * ãƒ†ã‚­ã‚¹ãƒˆå†…ã§ã‚¯ã‚¨ãƒªã«ãƒãƒƒãƒã™ã‚‹ä½ç½®ã‚’æ¤œç´¢
   * @param {string} text - æ¤œç´¢å¯¾è±¡ãƒ†ã‚­ã‚¹ãƒˆ
   * @param {string} query - æ¤œç´¢ã‚¯ã‚¨ãƒªï¼ˆå°æ–‡å­—ï¼‰
   * @returns {Array<[number, number]>} ãƒãƒƒãƒä½ç½®ã®é…åˆ—
   */
  function findMatches(text, query) {
    const normalizedText = text.toLowerCase();
    const matches = [];
    let startIndex = 0;

    while (true) {
      const index = normalizedText.indexOf(query, startIndex);
      if (index === -1) break;
      matches.push([index, index + query.length]);
      startIndex = index + 1;
    }

    return matches;
  }

  /**
   * æ¤œç´¢ã‚’å®Ÿè¡Œ
   * @param {string} query - æ¤œç´¢ã‚¯ã‚¨ãƒª
   * @returns {SearchResult[]} æ¤œç´¢çµæœ
   */
  function searchArticles(query) {
    const trimmedQuery = query.trim();
    if (!trimmedQuery || searchIndex.length === 0) {
      return [];
    }

    const normalizedQuery = trimmedQuery.toLowerCase();
    const results = [];

    for (const item of searchIndex) {
      const matches = [];
      let score = 0;

      // ã‚¿ã‚¤ãƒˆãƒ«ã®æ¤œç´¢
      const titleMatches = findMatches(item.title, normalizedQuery);
      if (titleMatches.length > 0) {
        score += SCORE_WEIGHTS.title * titleMatches.length;
        matches.push({ field: 'title', indices: titleMatches });
      }

      // ã‚¿ã‚°ã®æ¤œç´¢
      const tagMatches = [];
      for (const tag of item.tags) {
        const tagMatch = findMatches(tag, normalizedQuery);
        if (tagMatch.length > 0) {
          tagMatches.push(...tagMatch);
          score += SCORE_WEIGHTS.tags;
        }
      }
      if (tagMatches.length > 0) {
        matches.push({ field: 'tags', indices: tagMatches });
      }

      // èª¬æ˜ã®æ¤œç´¢
      const descMatches = findMatches(item.description, normalizedQuery);
      if (descMatches.length > 0) {
        score += SCORE_WEIGHTS.description * descMatches.length;
        matches.push({ field: 'description', indices: descMatches });
      }

      // æœ¬æ–‡ã®æ¤œç´¢
      const bodyMatches = findMatches(item.body, normalizedQuery);
      if (bodyMatches.length > 0) {
        score += SCORE_WEIGHTS.body * bodyMatches.length;
        matches.push({ field: 'body', indices: bodyMatches });
      }

      if (matches.length > 0) {
        results.push({ item, score, matches });
      }
    }

    // ã‚¹ã‚³ã‚¢ã®é™é †ã§ã‚½ãƒ¼ãƒˆ
    results.sort((a, b) => b.score - a.score);

    return results;
  }

  // ========================================
  // ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºé–¢æ•°
  // ========================================

  /**
   * ãƒ†ã‚­ã‚¹ãƒˆã«ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’é©ç”¨
   * @param {string} text - å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ
   * @param {Array<[number, number]>} indices - ãƒã‚¤ãƒ©ã‚¤ãƒˆä½ç½®
   * @returns {string} ãƒã‚¤ãƒ©ã‚¤ãƒˆé©ç”¨å¾Œã®HTML
   */
  function highlightText(text, indices) {
    if (!indices || indices.length === 0) {
      return escapeHtml(text);
    }

    // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é–‹å§‹ä½ç½®ã§ã‚½ãƒ¼ãƒˆ
    const sortedIndices = [...indices].sort((a, b) => a[0] - b[0]);

    let result = '';
    let lastIndex = 0;

    for (const [start, end] of sortedIndices) {
      if (start > lastIndex) {
        result += escapeHtml(text.slice(lastIndex, start));
      }
      result += `<mark class="bg-yellow-200 dark:bg-yellow-600 text-gray-900 dark:text-gray-100 px-0.5 rounded">${escapeHtml(text.slice(start, end))}</mark>`;
      lastIndex = end;
    }

    if (lastIndex < text.length) {
      result += escapeHtml(text.slice(lastIndex));
    }

    return result;
  }

  /**
   * HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
   * @param {string} text - ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å¯¾è±¡ãƒ†ã‚­ã‚¹ãƒˆ
   * @returns {string} ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å¾Œã®ãƒ†ã‚­ã‚¹ãƒˆ
   */
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ========================================
  // UIæ›´æ–°é–¢æ•°
  // ========================================

  /**
   * æ¤œç´¢çµæœã‚’UIã«åæ˜ 
   * @param {SearchResult[]} results - æ¤œç´¢çµæœ
   * @param {string} query - æ¤œç´¢ã‚¯ã‚¨ãƒª
   */
  function updateResults(results, query) {
    // å…¨è¦ç´ ã‚’éè¡¨ç¤º
    initialMessage.classList.add('hidden');
    noResults.classList.add('hidden');
    loadingIndicator.classList.add('hidden');
    resultsList.classList.add('hidden');
    resultsList.innerHTML = '';

    if (!query.trim()) {
      // ã‚¯ã‚¨ãƒªãŒç©ºã®å ´åˆã¯åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      initialMessage.classList.remove('hidden');
      return;
    }

    if (results.length === 0) {
      // çµæœãªã—ã®å ´åˆ
      noResults.classList.remove('hidden');
      return;
    }

    // æ¤œç´¢çµæœã‚’è¡¨ç¤º
    resultsList.classList.remove('hidden');

    for (const result of results) {
      const item = result.item;
      const li = document.createElement('li');

      // ã‚¿ã‚¤ãƒˆãƒ«ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      const titleMatch = result.matches.find((m) => m.field === 'title');
      const highlightedTitle = titleMatch
        ? highlightText(item.title, titleMatch.indices)
        : escapeHtml(item.title);

      // èª¬æ˜ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      const descMatch = result.matches.find((m) => m.field === 'description');
      const highlightedDesc = descMatch
        ? highlightText(item.description, descMatch.indices)
        : escapeHtml(item.description);

      // å…¬é–‹æ—¥ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
      const pubDate = new Date(item.pubDate);
      const formattedDate = pubDate.toLocaleDateString('ja-JP', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
      });

      li.innerHTML = `
        <article class="card p-4">
          <a href="/blog/${item.slug}" class="block group">
            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors mb-2">
              ${highlightedTitle}
            </h2>
            <p class="text-gray-600 dark:text-gray-400 text-sm mb-2">
              ${formattedDate}
            </p>
            <p class="text-gray-700 dark:text-gray-300 line-clamp-2">
              ${highlightedDesc}
            </p>
            ${
              item.tags.length > 0
                ? `
              <div class="flex flex-wrap gap-2 mt-3">
                ${item.tags
                  .map(
                    (tag) => `
                  <span class="inline-block px-2 py-1 text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded">
                    ${escapeHtml(tag)}
                  </span>
                `
                  )
                  .join('')}
              </div>
            `
                : ''
            }
          </a>
        </article>
      `;

      resultsList.appendChild(li);
    }

    // æ¤œç´¢çµæœæ•°ã‚’ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼ç”¨ã«é€šçŸ¥
    const resultCount = document.createElement('p');
    resultCount.className = 'sr-only';
    resultCount.textContent = `${results.length}ä»¶ã®è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;
    resultsList.prepend(resultCount);
  }

  // ========================================
  // ãƒ‡ãƒã‚¦ãƒ³ã‚¹é–¢æ•°
  // ========================================

  /**
   * ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†
   * @param {Function} func - å®Ÿè¡Œã™ã‚‹é–¢æ•°
   * @param {number} wait - å¾…æ©Ÿæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
   * @returns {Function} ãƒ‡ãƒã‚¦ãƒ³ã‚¹æ¸ˆã¿é–¢æ•°
   */
  function debounce(func, wait) {
    let timeoutId = null;
    return function (...args) {
      if (timeoutId) {
        clearTimeout(timeoutId);
      }
      timeoutId = setTimeout(() => {
        func.apply(this, args);
      }, wait);
    };
  }

  // ========================================
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
  // ========================================

  /**
   * æ¤œç´¢å‡¦ç†ã‚’å®Ÿè¡Œ
   */
  function handleSearch() {
    const query = searchInput.value;
    const results = searchArticles(query);
    updateResults(results, query);
  }

  // ãƒ‡ãƒã‚¦ãƒ³ã‚¹æ¸ˆã¿ã®æ¤œç´¢å‡¦ç†
  const debouncedSearch = debounce(handleSearch, DEBOUNCE_DELAY);

  // å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆã§æ¤œç´¢ã‚’å®Ÿè¡Œ
  searchInput.addEventListener('input', debouncedSearch);

  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚’é˜²æ­¢ï¼ˆEnterã‚­ãƒ¼å¯¾å¿œï¼‰
  searchInput.closest('form')?.addEventListener('submit', (e) => {
    e.preventDefault();
    handleSearch();
  });

  // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰åˆæœŸã‚¯ã‚¨ãƒªã‚’å–å¾—
  const urlParams = new URLSearchParams(window.location.search);
  const initialQuery = urlParams.get('q');
  if (initialQuery) {
    searchInput.value = initialQuery;
    handleSearch();
  }
</script>

<!--
  ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ã€‘
  .sr-onlyã‚¯ãƒ©ã‚¹ã®å®šç¾©
-->
<style>
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }
</style>
