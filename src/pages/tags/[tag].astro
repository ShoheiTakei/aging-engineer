---
/**
 * [tag].astro - ÂÄãÂà•„Çø„Ç∞„Éö„Éº„Ç∏
 *
 * TASK-0017: „Çø„Ç∞‰∏ÄË¶ß„Éö„Éº„Ç∏„ÅÆÂÆüË£Ö
 *
 * „ÄêÊ©üËÉΩÊ¶ÇË¶Å„Äë: ÁâπÂÆö„Çø„Ç∞„ÇíÊåÅ„Å§Ë®ò‰∫ã‰∏ÄË¶ß„ÇíË°®Á§∫„Åô„Çã„Éö„Éº„Ç∏
 * „ÄêÂÆüË£ÖÊñπÈáù„Äë: „Çª„Éû„É≥„ÉÜ„Ç£„ÉÉ„ÇØHTML„Å®WCAG 2.1 AAÊ∫ñÊã†„ÅÆ„Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£„ÇíÂÆüÁèæ
 * „ÄêË®≠Ë®àÊñπÈáù„Äë: „Çº„É≠JavaScript„ÄÅSSGÂ∞ÇÁî®„ÄÅIslands ArchitectureÊ¥ªÁî®„Å´„Çà„ÇãÊúÄÈ´ò„ÅÆ„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ
 * „Äê„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„Äë: „Éì„É´„ÉâÊôÇÈùôÁöÑÁîüÊàê„Å´„Çà„ÇäÂÆüË°åÊôÇ„Ç™„Éº„Éê„Éº„Éò„ÉÉ„Éâ„Çº„É≠„ÄÅLighthouse 90+ÁÇπÂØæÂøú
 *
 * Èñ¢ÈÄ£Ë¶Å‰ª∂:
 * - REQ-302: „Çø„Ç∞‰∏ÄË¶ßË°®Á§∫
 * - REQ-303: „Çø„Ç∞Âà•Ë®ò‰∫ã‰∏ÄË¶ß
 * - NFR-301: „Çª„Éû„É≥„ÉÜ„Ç£„ÉÉ„ÇØHTML‰ΩøÁî®
 * - NFR-302: „Ç≠„Éº„Éú„Éº„Éâ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ÂØæÂøú
 * - NFR-303: ARIA„É©„Éô„É´Ë®≠ÂÆö
 * - NFR-304: „Éï„Ç©„Éº„Ç´„ÇπÂèØË¶ñÂåñ
 *
 * ‰ø°È†ºÊÄß: üîµ Ë¶Å‰ª∂ÂÆöÁæ©Êõ∏„Éª„Ç¢„Éº„Ç≠„ÉÜ„ÇØ„ÉÅ„É£Ë®≠Ë®à„Å´Âü∫„Å•„ÅèÂÆüË£Ö
 */

import { getCollection } from 'astro:content';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { formatDate } from '../../utils/date';

// ========================================
// ÈùôÁöÑ„Éë„ÇπÁîüÊàê
// ========================================

/**
 * „ÄêgetStaticPaths„Äë: ÈùôÁöÑ„Éë„Çπ„ÅÆÁîüÊàê
 * „ÄêË®≠Ë®àÊñπÈáù„Äë: „Åô„Åπ„Å¶„ÅÆ‰∏ÄÊÑè„Å™„Çø„Ç∞„Å´ÂØæ„Åó„Å¶„Éö„Éº„Ç∏„ÇíÁîüÊàê
 * üîµ ‰ø°È†ºÊÄß: architecture.md„ÄÅAstroÂÖ¨Âºè„Éâ„Ç≠„É•„É°„É≥„Éà„Çà„Çä
 */
export async function getStaticPaths() {
  /**
   * „Çø„Ç∞„Åã„ÇâURL„Çπ„É©„ÉÉ„Ç∞„ÇíÁîüÊàê„Åô„Çã
   * @param tag - „Çø„Ç∞Âêç
   * @returns URL„Å´‰ΩøÁî®„Åß„Åç„Çã„Çπ„É©„ÉÉ„Ç∞
   *
   * „ÄêÂá¶ÁêÜÂÜÖÂÆπ„Äë:
   * - Ëã±Ë™û„Çø„Ç∞„ÅØÂ∞èÊñáÂ≠ó„Å´Â§âÊèõ
   * - „Çπ„Éö„Éº„Çπ„ÅØ„Éè„Ç§„Éï„É≥„Å´Â§âÊèõ
   * - Êó•Êú¨Ë™û„Çø„Ç∞„ÅØ„Åù„ÅÆ„Åæ„Åæ‰ΩøÁî®
   *
   * üîµ ‰ø°È†ºÊÄß„É¨„Éô„É´: „Çø„Ç∞‰∏ÄË¶ß„Éö„Éº„Ç∏„Å®Âêå„Åò„É≠„Ç∏„ÉÉ„ÇØ
   */
  const generateTagSlug = (tag: string): string => {
    return tag.toLowerCase().replace(/\s+/g, '-');
  };

  // „ÄêË®ò‰∫ãÂèñÂæó„Äë: Content Collections„Åã„ÇâÂÖ®Ë®ò‰∫ã„ÇíÂèñÂæó
  const allPosts = await getCollection('blog');

  // „ÄêÂÖ¨ÈñãË®ò‰∫ã„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞„Äë: ‰∏ãÊõ∏„ÅçË®ò‰∫ã„ÇíÈô§Â§ñ
  const publishedPosts = allPosts.filter((post) => !post.data.draft);

  // „Äê„Çø„Ç∞ÂèéÈõÜ„Äë: „Åô„Åπ„Å¶„ÅÆ‰∏ÄÊÑè„Å™„Çø„Ç∞„ÇíÂèéÈõÜ
  const allTags = new Set<string>();
  for (const post of publishedPosts) {
    for (const tag of post.data.tags) {
      allTags.add(tag);
    }
  }

  // „Äê„Éë„ÇπÁîüÊàê„Äë: ÂêÑ„Çø„Ç∞„Å´ÂØæ„Åó„Å¶„Éë„Çπ„ÇíÁîüÊàê
  return [...allTags].map((tag) => ({
    params: { tag: generateTagSlug(tag) },
    props: { tag, posts: publishedPosts.filter((post) => post.data.tags.includes(tag)) },
  }));
}

// ========================================
// PropsÂèñÂæó
// ========================================

interface Props {
  tag: string;
  posts: Awaited<ReturnType<typeof getCollection<'blog'>>>;
}

const { tag, posts } = Astro.props;

// „ÄêË®ò‰∫ã„ÇΩ„Éº„Éà„Äë: ÂÖ¨ÈñãÊó•„ÅÆÊñ∞„Åó„ÅÑÈ†Ü„Å´„ÇΩ„Éº„Éà
const sortedPosts = posts.sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

// ========================================
// „Éö„Éº„Ç∏„É°„Çø„Éá„Éº„Çø
// ========================================

const pageTitle = `„Çø„Ç∞: ${tag} | Aging Engineer Blog`;
const pageDescription = `„Äå${tag}„Äç„Çø„Ç∞„Åå‰ªò„ÅÑ„ÅüË®ò‰∫ã‰∏ÄË¶ß„Åß„Åô„ÄÇ${posts.length}‰ª∂„ÅÆË®ò‰∫ã„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ`;
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  ogType="website"
>
  <!--
    „Äê„Éö„Éº„Ç∏ÊßãÈÄ†„Äë
    Header + Main + Footer „ÅÆ3Â±§ÊßãÈÄ†
    - Flexbox„Çí‰ΩøÁî®„Åó„Å¶Footer„Çí‰∏ãÈÉ®„Å´Âõ∫ÂÆö
    - „Çª„Éû„É≥„ÉÜ„Ç£„ÉÉ„ÇØHTMLÔºà<main>Ôºâ„Çí‰ΩøÁî®
    üîµ ‰ø°È†ºÊÄß„É¨„Éô„É´: NFR-301Ë¶Å‰ª∂„Å´Âü∫„Å•„ÅèÂÆüË£Ö
  -->
  <div class="min-h-screen flex flex-col">
    <!--
      „Äê„Éò„ÉÉ„ÉÄ„Éº„Äë
      ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏„Éë„ÇπÔºà/tagsÔºâ„ÇíÊ∏°„Åó„Å¶„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Çí„Éè„Ç§„É©„Ç§„Éà
    -->
    <Header siteTitle="Aging Engineer Blog" currentPath="/tags" />

    <!--
      „Äê„É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Äë
      „Çª„Éû„É≥„ÉÜ„Ç£„ÉÉ„ÇØHTML„Å®„Åó„Å¶<main>„Çø„Ç∞„Çí‰ΩøÁî®ÔºàNFR-301Ôºâ
      aria-label„Åß„Ç≥„É≥„ÉÜ„É≥„ÉÑÈ†òÂüü„ÇíÊòéÁ§∫ÔºàNFR-303Ôºâ
    -->
    <main class="flex-1 container-narrow py-8 md:py-12" aria-label={`„Çø„Ç∞„Äå${tag}„Äç„ÅÆË®ò‰∫ã‰∏ÄË¶ß`}>
      <!--
        „Äê„Éö„Éº„Ç∏„Éò„ÉÉ„ÉÄ„Éº„Äë
        „Çø„Ç∞Âêç„Å®Ë®ò‰∫ãÊï∞„ÇíË°®Á§∫
      -->
      <header class="mb-8 md:mb-12">
        <!--
          „Äê„Éë„É≥„Åè„Åö„É™„Çπ„ÉàÈ¢®„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Äë
          „Çø„Ç∞‰∏ÄË¶ß„Éö„Éº„Ç∏„Å∏Êàª„Çã„É™„É≥„ÇØ
        -->
        <nav class="mb-4" aria-label="„Éë„É≥„Åè„Åö„É™„Çπ„Éà">
          <a
            href="/tags"
            class="text-blue-600 dark:text-blue-400 hover:underline inline-flex items-center gap-1"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            „Çø„Ç∞‰∏ÄË¶ß
          </a>
        </nav>

        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-gray-100 mb-4">
          <span class="text-blue-600 dark:text-blue-400">#</span>{tag}
        </h1>
        <p class="text-gray-600 dark:text-gray-400 text-lg">
          {posts.length}‰ª∂„ÅÆË®ò‰∫ã
        </p>
      </header>

      <!--
        „ÄêË®ò‰∫ã„É™„Çπ„Éà„Äë
        „Çø„Ç∞„Å´Èñ¢ÈÄ£„Åô„ÇãË®ò‰∫ã‰∏ÄË¶ß„ÇíË°®Á§∫
      -->
      {sortedPosts.length > 0 ? (
        <section aria-label="Ë®ò‰∫ã‰∏ÄË¶ß">
          <ul class="space-y-6">
            {sortedPosts.map((post) => (
              <li>
                <!--
                  „ÄêË®ò‰∫ã„Ç´„Éº„Éâ„Äë
                  ÂêÑË®ò‰∫ã„Çí„Ç´„Éº„ÉâÂΩ¢Âºè„ÅßË°®Á§∫

                  „Äê„Çπ„Çø„Ç§„É™„É≥„Ç∞„Äë:
                  - ËÉåÊôØ: bg-gray-50Ôºà„É©„Ç§„ÉàÔºâ„ÄÅdark:bg-gray-800Ôºà„ÉÄ„Éº„ÇØÔºâ
                  - „Éú„Éº„ÉÄ„Éº: border-gray-200Ôºà„É©„Ç§„ÉàÔºâ„ÄÅdark:border-gray-700Ôºà„ÉÄ„Éº„ÇØÔºâ
                  - „Éõ„Éê„ÉºÊôÇ: ÂΩ±„ÇíËøΩÂä†„ÄÅ„Éú„Éº„ÉÄ„ÉºËâ≤„ÇíÂ§âÊõ¥

                  „Äê„Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£„Äë:
                  - <a>„Çø„Ç∞„Åß„Ç≠„Éº„Éú„Éº„Éâ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ÂØæÂøúÔºàNFR-302Ôºâ
                  - „Éï„Ç©„Éº„Ç´„ÇπÂèØË¶ñÂåñÔºàNFR-304Ôºâ

                  üîµ ‰ø°È†ºÊÄß„É¨„Éô„É´: NFR-302ÔΩûNFR-304Ë¶Å‰ª∂„Å´Âü∫„Å•„ÅèÂÆüË£Ö
                -->
                <a
                  href={`/blog/${post.id}`}
                  class="block p-6 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 hover:shadow-md hover:border-blue-500 dark:hover:border-blue-400 transition-all duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2"
                >
                  <!--
                    „ÄêË®ò‰∫ã„Çø„Ç§„Éà„É´„Äë
                    Â§™Â≠ó„ÅßÁõÆÁ´ã„Å§„Çà„ÅÜ„Å´Ë°®Á§∫
                  -->
                  <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">
                    {post.data.title}
                  </h2>

                  <!--
                    „ÄêË®ò‰∫ãË™¨Êòé„Äë
                    2Ë°å„ÅßÁúÅÁï•Ë°®Á§∫
                  -->
                  <p class="text-gray-600 dark:text-gray-400 mb-3 line-clamp-2">
                    {post.data.description}
                  </p>

                  <!--
                    „Äê„É°„ÇøÊÉÖÂ†±„Äë
                    ÂÖ¨ÈñãÊó•„Å®„Çø„Ç∞‰∏ÄË¶ß
                  -->
                  <div class="flex flex-wrap items-center gap-4 text-sm text-gray-500 dark:text-gray-400">
                    <time datetime={post.data.pubDate.toISOString()} class="flex items-center gap-1">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                      <span>{formatDate(post.data.pubDate)}</span>
                    </time>

                    <!--
                      „Äê„Çø„Ç∞‰∏ÄË¶ß„Äë
                      Ë®ò‰∫ã„Å´Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„Çø„Ç∞„ÇíË°®Á§∫
                    -->
                    {post.data.tags.length > 0 && (
                      <div class="flex flex-wrap gap-1">
                        {post.data.tags.map((postTag: string) => (
                          <span
                            class:list={[
                              "inline-block px-2 py-0.5 text-xs font-medium rounded-full",
                              postTag === tag
                                ? "bg-blue-600 text-white dark:bg-blue-500"
                                : "bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300"
                            ]}
                          >
                            #{postTag}
                          </span>
                        ))}
                      </div>
                    )}
                  </div>
                </a>
              </li>
            ))}
          </ul>
        </section>
      ) : (
        <!--
          „ÄêË®ò‰∫ã„Å™„Åó„É°„ÉÉ„Çª„Éº„Ç∏„Äë
          „Çø„Ç∞„Å´Èñ¢ÈÄ£„Åô„ÇãÂÖ¨ÈñãË®ò‰∫ã„Åå„Å™„ÅÑÂ†¥Âêà
          üîµ ‰ø°È†ºÊÄß„É¨„Éô„É´: EDGE-001Ë¶Å‰ª∂„Å´Âü∫„Å•„ÅèÂÆüË£Ö
        -->
        <section
          aria-label="Ë®ò‰∫ã„Å™„Åó"
          class="text-center py-12"
        >
          <p class="text-gray-500 dark:text-gray-400 text-lg">
            „Åì„ÅÆ„Çø„Ç∞„Å´Èñ¢ÈÄ£„Åô„ÇãË®ò‰∫ã„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ
          </p>
        </section>
      )}
    </main>

    <!--
      „Äê„Éï„ÉÉ„Çø„Éº„Äë
      „Çµ„Ç§„ÉàÂêç„ÇíÊ∏°„Åó„Å¶„Ç≥„Éî„Éº„É©„Ç§„ÉàË°®Ë®ò
    -->
    <Footer siteName="Aging Engineer Blog" />
  </div>
</BaseLayout>
