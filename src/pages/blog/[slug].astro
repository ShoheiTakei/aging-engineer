---
/**
 * [slug].astro - è¨˜äº‹è©³ç´°ãƒšãƒ¼ã‚¸
 *
 * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: å€‹åˆ¥è¨˜äº‹ã®è©³ç´°è¡¨ç¤ºãƒšãƒ¼ã‚¸ã‚’æä¾›
 * ã€æ”¹å–„å†…å®¹ã€‘: TDDã§å®Ÿè£…ã€‚ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã‚’æ´»ç”¨ã—ãŸæ§‹é€ åŒ–ã•ã‚ŒãŸãƒšãƒ¼ã‚¸
 * ã€å®Ÿè£…æ–¹é‡ã€‘: Content Collections APIã‚’ä½¿ç”¨ã—ãŸå‹å®‰å…¨ãªMarkdownãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
 * ã€è¨­è¨ˆæ–¹é‡ã€‘: ã‚¼ãƒ­JavaScriptï¼ˆç›®æ¬¡ã®ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é™¤ãï¼‰ã€SSGå°‚ç”¨
 * ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: ãƒ“ãƒ«ãƒ‰æ™‚é™çš„ç”Ÿæˆã«ã‚ˆã‚Šå®Ÿè¡Œæ™‚ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚¼ãƒ­
 * ã€ä¿å®ˆæ€§ã€‘: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ†é›¢ã€ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã®æ´»ç”¨
 * ğŸ”µ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: REQ-102ã€requirements.mdã€architecture.mdã«åŸºã¥ãå®Ÿè£…
 *
 * é–¢é€£è¦ä»¶:
 * - REQ-102: è¨˜äº‹è©³ç´°è¡¨ç¤º
 * - REQ-001: frontmatterã§pubDate, updatedDateã‚’ç®¡ç†
 * - REQ-801: èª­äº†æ™‚é–“ã‚’è‡ªå‹•è¨ˆç®—ã—ã¦è¡¨ç¤º
 * - REQ-901: è¨˜äº‹ã®è¦‹å‡ºã—ï¼ˆh2, h3ï¼‰ã‹ã‚‰ç›®æ¬¡ã‚’è‡ªå‹•ç”Ÿæˆ
 * - REQ-111: Shikiã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆå¯¾å¿œ
 * - REQ-301: ã‚¿ã‚°è¡¨ç¤º
 *
 * ãƒ†ã‚¹ãƒˆå¯¾å¿œ:
 * - slug.test.ts: ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã¨çµ±åˆãƒ†ã‚¹ãƒˆ
 */

import { getCollection, render } from 'astro:content';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { formatDate } from '../../utils/date';
import { calculateReadingTime, formatReadingTime } from '../../utils/readingTime';
import { generateTOC } from '../../utils/toc';

/**
 * ã€getStaticPathsã€‘: é™çš„ãƒ‘ã‚¹ã®ç”Ÿæˆ
 * ã€è¨­è¨ˆæ–¹é‡ã€‘: Content Collectionsã‹ã‚‰å…¬é–‹è¨˜äº‹ã®ã¿ã‚’å–å¾—ã—ã€slugãƒ™ãƒ¼ã‚¹ã§ãƒ‘ã‚¹ã‚’ç”Ÿæˆ
 * ğŸ”µ ä¿¡é ¼æ€§: architecture.mdã€Astroå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚ˆã‚Š
 */
export async function getStaticPaths() {
  // ã€è¨˜äº‹å–å¾—ã€‘: Content Collectionsã‹ã‚‰å…¨è¨˜äº‹ã‚’å–å¾—
  const posts = await getCollection('blog', ({ data }) => {
    // ã€ä¸‹æ›¸ãé™¤å¤–ã€‘: draft: trueã®è¨˜äº‹ã¯é™¤å¤–
    return data.draft !== true;
  });

  // ã€ãƒ‘ã‚¹ç”Ÿæˆã€‘: å„è¨˜äº‹ã®slugã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦è¿”ã™
  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

// ã€Propså–å¾—ã€‘: getStaticPathsã‹ã‚‰æ¸¡ã•ã‚ŒãŸè¨˜äº‹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
const { post } = Astro.props;

// ã€è¨˜äº‹ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã€‘: Markdownã‚’HTMLã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
const { Content, headings } = await render(post);

// ã€ãƒ•ãƒ­ãƒ³ãƒˆãƒã‚¿ãƒ¼å–å¾—ã€‘: è¨˜äº‹ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
const { title, description, pubDate, updatedDate, tags = [], coverImage } = post.data;

// ã€èª­äº†æ™‚é–“è¨ˆç®—ã€‘: è¨˜äº‹æœ¬æ–‡ã‹ã‚‰èª­äº†æ™‚é–“ã‚’è¨ˆç®—
const readingTime = calculateReadingTime(post.body || '');
const formattedReadingTime = formatReadingTime(readingTime);

// ã€ç›®æ¬¡ç”Ÿæˆã€‘: è¦‹å‡ºã—ã‹ã‚‰ç›®æ¬¡ã‚’ç”Ÿæˆ
const toc = generateTOC(headings);

// ã€æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€‘: æ—¥æœ¬èªå½¢å¼ã«å¤‰æ›
const formattedPubDate = formatDate(pubDate);
const formattedUpdatedDate = updatedDate ? formatDate(updatedDate) : null;

// ã€ã‚µã‚¤ãƒˆè¨­å®šã€‘: ã‚µã‚¤ãƒˆæƒ…å ±ï¼ˆå°†æ¥çš„ã«ã¯è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å–å¾—ï¼‰
const siteTitle = 'Aging Engineer Blog';
const siteName = 'Aging Engineer';
---

<BaseLayout
  title={`${title} | ${siteTitle}`}
  description={description}
  ogType="article"
>
  <Header siteTitle={siteTitle} currentPath={`/blog/${post.id}`} />

  <article class="container-narrow py-8 md:py-12">
    <!--
      ã€è¨˜äº‹ãƒ˜ãƒƒãƒ€ãƒ¼ã€‘
      ã‚¿ã‚¤ãƒˆãƒ«ã€ãƒ¡ã‚¿æƒ…å ±ï¼ˆå…¬é–‹æ—¥ã€æ›´æ–°æ—¥ã€èª­äº†æ™‚é–“ã€ã‚¿ã‚°ï¼‰ã‚’è¡¨ç¤º
      ğŸ”µ ä¿¡é ¼æ€§: REQ-102ã€REQ-001ã€REQ-801ã‚ˆã‚Š
    -->
    <header class="mb-8 md:mb-12">
      <!-- ã‚«ãƒãƒ¼ç”»åƒ -->
      {coverImage && (
        <div class="mb-6 md:mb-8">
          <img
            src={coverImage}
            alt={`${title}ã®ã‚«ãƒãƒ¼ç”»åƒ`}
            class="w-full h-auto rounded-lg shadow-md"
            loading="lazy"
          />
        </div>
      )}

      <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
      <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-gray-900 dark:text-gray-100 mb-4 md:mb-6 leading-tight">
        {title}
      </h1>

      <!-- ãƒ¡ã‚¿æƒ…å ± -->
      <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600 dark:text-gray-400 mb-4 md:mb-6">
        <!-- å…¬é–‹æ—¥ -->
        <time datetime={pubDate.toISOString()} class="flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          <span>{formattedPubDate}</span>
        </time>

        <!-- æ›´æ–°æ—¥ï¼ˆã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤ºï¼‰ -->
        {formattedUpdatedDate && (
          <time datetime={updatedDate!.toISOString()} class="flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            <span>æ›´æ–°: {formattedUpdatedDate}</span>
          </time>
        )}

        <!-- èª­äº†æ™‚é–“ -->
        <span class="flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>{formattedReadingTime}</span>
        </span>
      </div>

      <!-- ã‚¿ã‚°ä¸€è¦§ -->
      {tags.length > 0 && (
        <div class="flex flex-wrap gap-2" aria-label="ã‚¿ã‚°ä¸€è¦§">
          {tags.map((tag: string) => (
            <a
              href={`/tags/${encodeURIComponent(tag)}`}
              class="inline-block px-3 py-1 text-sm font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-full hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors"
            >
              #{tag}
            </a>
          ))}
        </div>
      )}
    </header>

    <!--
      ã€ç›®æ¬¡ã€‘
      è¦‹å‡ºã—ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤ºï¼ˆEDGE-104å¯¾å¿œï¼‰
      ğŸ”µ ä¿¡é ¼æ€§: REQ-901ã€EDGE-104ã‚ˆã‚Š
    -->
    {toc.hasContent && (
      <nav
        class="mb-8 md:mb-12 p-4 md:p-6 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700"
        aria-label="ç›®æ¬¡"
      >
        <h2 class="text-lg font-bold text-gray-900 dark:text-gray-100 mb-4">
          ç›®æ¬¡
        </h2>
        <ul class="space-y-2">
          {toc.items.map((item) => (
            <li>
              <a
                href={`#${item.slug}`}
                class="text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
              >
                {item.text}
              </a>
              {item.children.length > 0 && (
                <ul class="ml-4 mt-2 space-y-1">
                  {item.children.map((child) => (
                    <li>
                      <a
                        href={`#${child.slug}`}
                        class="text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors text-sm"
                      >
                        {child.text}
                      </a>
                    </li>
                  ))}
                </ul>
              )}
            </li>
          ))}
        </ul>
      </nav>
    )}

    <!--
      ã€è¨˜äº‹æœ¬æ–‡ã€‘
      Markdownâ†’HTMLãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°çµæœã‚’è¡¨ç¤º
      Shikiã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆã¯astro.config.mjsã§è¨­å®šæ¸ˆã¿
      ğŸ”µ ä¿¡é ¼æ€§: REQ-102ã€REQ-111ã‚ˆã‚Š
    -->
    <div class="prose prose-lg dark:prose-invert max-w-none prose-headings:scroll-mt-20 prose-a:text-blue-600 dark:prose-a:text-blue-400 prose-code:before:content-none prose-code:after:content-none">
      <Content />
    </div>

    <!--
      ã€è¨˜äº‹ãƒ•ãƒƒã‚¿ãƒ¼ã€‘
      è¨˜äº‹çµ‚äº†ã®åŒºåˆ‡ã‚Šã¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
      ğŸŸ¡ ä¿¡é ¼æ€§: ä¸€èˆ¬çš„ãªãƒ–ãƒ­ã‚°è¦ä»¶ã‚ˆã‚Š
    -->
    <footer class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
      <div class="flex justify-between items-center">
        <a
          href="/blog"
          class="inline-flex items-center gap-2 text-blue-600 dark:text-blue-400 hover:underline"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          è¨˜äº‹ä¸€è¦§ã«æˆ»ã‚‹
        </a>
      </div>
    </footer>
  </article>

  <Footer siteName={siteName} />
</BaseLayout>
