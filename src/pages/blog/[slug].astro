---
/**
 * è¨˜äº‹è©³ç´°ãƒšãƒ¼ã‚¸
 *
 * è¦ä»¶:
 * - TASK-0014: è¨˜äº‹è©³ç´°ãƒšãƒ¼ã‚¸ã®å®Ÿè£…ï¼ˆç›®æ¬¡ãƒ»å‰å¾Œè¨˜äº‹ãƒŠãƒ“å¯¾å¿œï¼‰
 * - NFR-301: ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯HTML
 * - NFR-302: ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ
 *
 * ä¿¡é ¼æ€§: ğŸ”µ ã‚¿ã‚¹ã‚¯å®šç¾©ã‚ˆã‚Š
 */

import { getCollection, render } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';
import PostNavigation from '../../components/PostNavigation.astro';
import RelatedArticles from '../../components/RelatedArticles.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { formatDate } from '../../utils/date';
import { calculateReadingTime, formatReadingTime } from '../../utils/readingTime';
import { getRelatedPosts } from '../../utils/relatedArticles';
import { generateTOC } from '../../utils/toc';
import { siteConfig } from '../../config/site';

type BlogPost = CollectionEntry<'blog'>;

export async function getStaticPaths() {
  // å…¨ãƒ–ãƒ­ã‚°è¨˜äº‹ã‚’å–å¾—ï¼ˆä¸‹æ›¸ãã‚’é™¤å¤–ï¼‰
  const allPosts = await getCollection('blog', ({ data }) => !data.draft);

  // å…¬é–‹æ—¥ã§é™é †ã‚½ãƒ¼ãƒˆ
  const sortedPosts = allPosts.sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

  return sortedPosts.map((post, index) => ({
    params: { slug: post.id },
    props: {
      post,
      prevPost: index < sortedPosts.length - 1 ? sortedPosts[index + 1] : null,
      nextPost: index > 0 ? sortedPosts[index - 1] : null,
      allPosts: sortedPosts,
    },
  }));
}

interface Props {
  post: BlogPost;
  prevPost: BlogPost | null;
  nextPost: BlogPost | null;
  allPosts: BlogPost[];
}

const { post, prevPost, nextPost, allPosts } = Astro.props;

// è¨˜äº‹æœ¬æ–‡ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
const { Content, headings } = await render(post);

// ç›®æ¬¡ã‚’ç”Ÿæˆ
const toc = generateTOC(headings);

// èª­äº†æ™‚é–“ã‚’è¨ˆç®—
const readingTime = calculateReadingTime(post.body || '');
const readingTimeText = formatReadingTime(readingTime);

// é–¢é€£è¨˜äº‹ã‚’å–å¾—ï¼ˆæœ€å¤§3ä»¶ï¼‰
const relatedPosts = getRelatedPosts(post, allPosts, { maxItems: 3 });
---

<BaseLayout
  title={post.data.title}
  description={post.data.description}
  type="article"
  publishedTime={post.data.pubDate}
  modifiedTime={post.data.updatedDate}
  tags={post.data.tags}
>
  <Header slot="header" siteTitle={siteConfig.name} currentPath={`/blog/${post.id}`} />

  <article class="container-narrow py-12">
    <!-- è¨˜äº‹ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="mb-8">
      <!-- ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ -->
      <nav aria-label="ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ" class="mb-4">
        <ol class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400">
          <li>
            <a href="/" class="hover:text-blue-600 dark:hover:text-blue-400">ãƒ›ãƒ¼ãƒ </a>
          </li>
          <li aria-hidden="true">/</li>
          <li>
            <a href="/blog/1" class="hover:text-blue-600 dark:hover:text-blue-400">ãƒ–ãƒ­ã‚°</a>
          </li>
          <li aria-hidden="true">/</li>
          <li aria-current="page" class="text-gray-900 dark:text-gray-100 truncate max-w-xs">
            {post.data.title}
          </li>
        </ol>
      </nav>

      <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-gray-100 mb-4">
        {post.data.title}
      </h1>

      <!-- ãƒ¡ã‚¿æƒ…å ± -->
      <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600 dark:text-gray-400 mb-4">
        <time datetime={post.data.pubDate.toISOString()}>
          {formatDate(post.data.pubDate)}
        </time>
        {post.data.updatedDate && post.data.updatedDate.getTime() !== post.data.pubDate.getTime() && (
          <span>
            ï¼ˆæ›´æ–°: <time datetime={post.data.updatedDate.toISOString()}>
              {formatDate(post.data.updatedDate)}
            </time>ï¼‰
          </span>
        )}
        <span aria-label="èª­äº†æ™‚é–“">{readingTimeText}</span>
      </div>

      <!-- ã‚¿ã‚° -->
      {post.data.tags.length > 0 && (
        <ul class="flex flex-wrap gap-2 list-none p-0 m-0" aria-label="ã‚¿ã‚°ä¸€è¦§">
          {post.data.tags.map((tag) => (
            <li>
              <a
                href={`/tags/${tag}`}
                class="bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 px-3 py-1 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors inline-block"
              >
                {tag}
              </a>
            </li>
          ))}
        </ul>
      )}
    </header>

    <!-- ç›®æ¬¡ -->
    {toc.hasContent && <TableOfContents toc={toc} />}

    <!-- è¨˜äº‹æœ¬æ–‡ -->
    <div class="prose prose-lg dark:prose-invert max-w-none mt-8">
      <Content />
    </div>

    <!-- é–¢é€£è¨˜äº‹ -->
    <RelatedArticles relatedPosts={relatedPosts} />

    <!-- å‰å¾Œè¨˜äº‹ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <PostNavigation prevPost={prevPost} nextPost={nextPost} />
  </article>

  <Footer slot="footer" siteName={siteConfig.name} />
</BaseLayout>
