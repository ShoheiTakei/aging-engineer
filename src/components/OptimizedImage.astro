---
/**
 * OptimizedImage - æœ€é©åŒ–ç”»åƒã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
 *
 * WebP/AVIFå¤‰æ›ã«å¯¾å¿œã—ãŸç”»åƒæœ€é©åŒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã€‚
 * Astro Imageã®æ©Ÿèƒ½ã‚’æ´»ç”¨ã—ã€ãƒ¢ãƒ€ãƒ³ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®è‡ªå‹•å¤‰æ›ã‚’è¡Œã†ã€‚
 *
 * è¦ä»¶:
 * - TASK-0022: ç”»åƒæœ€é©åŒ–ï¼ˆWebP/AVIFå¤‰æ›ï¼‰
 * - R2ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨ã®çµ±åˆå¯¾å¿œ
 *
 * ä¿¡é ¼æ€§: ğŸ”µ tech-stack.mdãƒ»TASK-0022ã‚ˆã‚Š
 */

import { Image, getImage } from 'astro:assets';
import type { ImageOutputFormat } from 'astro';

interface Props {
  /** ç”»åƒã®ã‚½ãƒ¼ã‚¹ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã¾ãŸã¯ãƒªãƒ¢ãƒ¼ãƒˆURLï¼‰ */
  src: string | ImageMetadata;
  /** ä»£æ›¿ãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¿…é ˆï¼‰ */
  alt: string;
  /** è¡¨ç¤ºå¹… */
  width: number;
  /** è¡¨ç¤ºé«˜ã• */
  height: number;
  /** å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: webpï¼‰ */
  format?: ImageOutputFormat;
  /** å“è³ªï¼ˆ1-100ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 80ï¼‰ */
  quality?: number;
  /** loadingå±æ€§ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: lazyï¼‰ */
  loading?: 'lazy' | 'eager';
  /** decodingå±æ€§ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: asyncï¼‰ */
  decoding?: 'sync' | 'async' | 'auto';
  /** è¿½åŠ ã®CSSã‚¯ãƒ©ã‚¹ */
  class?: string;
  /** fetchpriorityå±æ€§ï¼ˆé‡è¦ãªç”»åƒç”¨ï¼‰ */
  fetchpriority?: 'high' | 'low' | 'auto';
  /** AVIFå½¢å¼ã‚‚ç”Ÿæˆã™ã‚‹ã‹ */
  includeAvif?: boolean;
}

const {
  src,
  alt,
  width,
  height,
  format = 'webp',
  quality = 80,
  loading = 'lazy',
  decoding = 'async',
  class: className = '',
  fetchpriority,
  includeAvif = true,
} = Astro.props;

// ãƒªãƒ¢ãƒ¼ãƒˆç”»åƒã‹ãƒ­ãƒ¼ã‚«ãƒ«ç”»åƒã‹ã‚’åˆ¤å®š
const isRemote = typeof src === 'string' && src.startsWith('http');

// ç”»åƒã‚½ãƒ¼ã‚¹ã®å‹ã‚’æ˜ç¢ºã«åˆ†é›¢
const remoteUrl = isRemote ? (src as string) : null;
const localSrc = !isRemote ? (src as ImageMetadata) : null;

// pictureè¦ç´ ç”¨ã®ã‚½ãƒ¼ã‚¹ã‚’ç”Ÿæˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç”»åƒã®ã¿ï¼‰
const generateSources = async () => {
  const sources: Array<{ srcset: string; type: string }> = [];

  if (isRemote || !localSrc) {
    return sources;
  }

  // AVIFå½¢å¼ã‚’è¿½åŠ ï¼ˆæœ€ã‚‚åŠ¹ç‡çš„ï¼‰
  if (includeAvif) {
    try {
      const avifImage = await getImage({
        src: localSrc,
        width,
        height,
        format: 'avif',
        quality: quality - 5,
      });
      sources.push({
        srcset: avifImage.src,
        type: 'image/avif',
      });
    } catch {
      // AVIFãŒå¤±æ•—ã—ãŸå ´åˆã¯ç„¡è¦–
    }
  }

  // WebPå½¢å¼ã‚’è¿½åŠ 
  try {
    const webpImage = await getImage({
      src: localSrc,
      width,
      height,
      format: 'webp',
      quality,
    });
    sources.push({
      srcset: webpImage.src,
      type: 'image/webp',
    });
  } catch {
    // WebPãŒå¤±æ•—ã—ãŸå ´åˆã¯ç„¡è¦–
  }

  return sources;
};

const sources = await generateSources();
---

{
  remoteUrl ? (
    <Image
      src={remoteUrl}
      alt={alt}
      width={width}
      height={height}
      format={format}
      quality={quality}
      loading={loading}
      decoding={decoding}
      class={className}
      fetchpriority={fetchpriority}
    />
  ) : localSrc && sources.length > 0 ? (
    <picture>
      {sources.map((source) => (
        <source srcset={source.srcset} type={source.type} />
      ))}
      <Image
        src={localSrc}
        alt={alt}
        width={width}
        height={height}
        format={format}
        quality={quality}
        loading={loading}
        decoding={decoding}
        class={className}
        fetchpriority={fetchpriority}
      />
    </picture>
  ) : localSrc ? (
    <Image
      src={localSrc}
      alt={alt}
      width={width}
      height={height}
      format={format}
      quality={quality}
      loading={loading}
      decoding={decoding}
      class={className}
      fetchpriority={fetchpriority}
    />
  ) : null
}
