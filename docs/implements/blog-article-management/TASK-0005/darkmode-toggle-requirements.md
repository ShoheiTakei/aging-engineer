# TASK-0005: ダークモード切り替え機能 - TDD要件定義書

**作成日**: 2025-12-31
**タスクタイプ**: TDD
**見積もり工数**: 6時間
**優先度**: P1
**依存タスク**: TASK-0004（ヘッダー・フッターコンポーネント）- 完了済み

---

## 1. 機能の概要

### 🔵 機能概要（青信号: tech-stack.md・タスクノートより確実に導出）

**何をする機能か**:
ThemeToggleコンポーネントを実装し、ユーザーがダークモードとライトモードを切り替えられるようにする。テーマ設定はlocalStorageに永続化され、ページリロード時も設定が維持される。

**どのような問題を解決するか**:
- ユーザーの好みに応じたテーマ選択を可能にする
- ダークモード優先のデフォルトでエンジニア向けブログに最適な体験を提供
- 夜間や暗い環境での閲覧時の目の疲れを軽減
- ページ読み込み時のテーマフラッシュ（ちらつき）を防止

**想定されるユーザー**:
- サイト訪問者（ブログ読者）
- ダークモード・ライトモードを好みに応じて切り替えたいユーザー
- システム設定に基づいたテーマを期待するユーザー

**システム内での位置づけ**:
- ThemeToggleコンポーネントはHeader.astro内に配置
- BaseLayout.astroにテーマ初期化スクリプトを追加
- Tailwind CSS `darkMode: 'class'` を使用したクラスベースのダークモード

**参照したEARS要件**: tech-stack.md（ダークモード実装方針）
**参照した設計文書**: architecture.md（コンポーネント構成）

---

## 2. 入力・出力の仕様

### 🔵 入力パラメータ（青信号: tech-stack.md・タスクノートより）

#### ThemeToggleコンポーネント（Props不要）

ThemeToggleコンポーネントは外部からのPropsを受け取らない純粋なUIコンポーネントです。

#### 内部状態の入力

| 入力ソース | 型 | 説明 | 備考 |
|-----------|-----|------|------|
| `localStorage.getItem('theme')` | `string \| null` | 保存されたテーマ設定 | 'dark' \| 'light' \| null |
| `document.documentElement.classList` | `DOMTokenList` | 現在の`<html>`クラス | 'dark'クラスの有無で判定 |

### 🔵 出力（青信号: tech-stack.md・タスクノートより）

#### DOM操作

| 出力先 | 操作 | 説明 |
|--------|------|------|
| `document.documentElement.classList` | `add('dark')` / `remove('dark')` | テーマクラスの切り替え |
| `localStorage.setItem('theme', value)` | 'dark' \| 'light' 保存 | テーマ設定の永続化 |

#### レンダリング出力

| 状態 | 表示されるアイコン | aria-label |
|------|------------------|------------|
| ダークモード | 月アイコン（`dark:block`） | "テーマを切り替える" |
| ライトモード | 太陽アイコン（`block dark:hidden`） | "テーマを切り替える" |

**参照したEARS要件**: tech-stack.md（デザインシステム・ダークモード実装方針）
**参照した設計文書**: タスクノート（ThemeToggle.astro設計仕様）

---

## 3. 制約条件

### 🔵 パフォーマンス要件（青信号: NFR-001より）

| 項目 | 要件 | 根拠 |
|------|------|------|
| Lighthouse Performance | 90+点維持 | NFR-001 |
| JavaScriptサイズ | 最小限 | Islands Architectureの原則 |
| 初期表示 | フラッシュなし | tech-stack.md・FOUC防止 |

**実現方法**:
- インラインスクリプト（`is:inline`）でテーマ初期化
- 外部ファイル読み込みなし（すべてインライン）
- 同期的なlocalStorageアクセス

### 🔵 アクセシビリティ要件（青信号: NFR-302～304より）

| 要件ID | 要件 | 実装方法 |
|--------|------|---------|
| NFR-302 | キーボードナビゲーション対応 | `<button>`要素使用（Tab, Enter, Space対応） |
| NFR-303 | ARIAラベル設定 | `aria-label="テーマを切り替える"` |
| NFR-304 | フォーカス可視化 | `focus-visible:ring-2 focus-visible:ring-blue-500` |

### 🔵 アーキテクチャ制約（青信号: tech-stack.mdより）

| 項目 | 制約 |
|------|------|
| ダークモード方式 | `darkMode: 'class'`（Tailwind CSS設定） |
| デフォルトテーマ | ダークモード |
| テーマ切り替え | `<html>`タグの`dark`クラスをトグル |
| 永続化 | localStorage使用 |
| 初期化タイミング | `<head>`内でインラインスクリプト実行 |

### 🟡 互換性制約（黄信号: 一般的なブラウザサポートから推測）

| 項目 | 制約 |
|------|------|
| ブラウザ | モダンブラウザ（ES2020+） |
| localStorage | 利用可能前提 |
| CSS | Tailwind CSS dark:クラス使用 |

**参照したEARS要件**: NFR-001, NFR-302, NFR-303, NFR-304
**参照した設計文書**: tech-stack.md, architecture.md

---

## 4. 想定される使用例

### 🔵 基本的な使用パターン（青信号: tech-stack.mdより）

#### パターン1: 初回訪問（デフォルトダークモード）

```
前提条件: localStorage に theme 設定なし
1. ユーザーがサイトにアクセス
2. テーマ初期化スクリプトが実行
3. localStorage.getItem('theme') が null を返す
4. デフォルトでダークモード適用（<html class="dark">）
5. ThemeToggleに月アイコンが表示
```

#### パターン2: ダークモードからライトモードへ切り替え

```
前提条件: 現在ダークモード
1. ユーザーがThemeToggleボタンをクリック
2. <html>タグから'dark'クラスを削除
3. localStorage.setItem('theme', 'light') を実行
4. 太陽アイコンに切り替わる
5. ページ全体がライトモードスタイルに変更
```

#### パターン3: ライトモードからダークモードへ切り替え

```
前提条件: 現在ライトモード
1. ユーザーがThemeToggleボタンをクリック
2. <html>タグに'dark'クラスを追加
3. localStorage.setItem('theme', 'dark') を実行
4. 月アイコンに切り替わる
5. ページ全体がダークモードスタイルに変更
```

#### パターン4: ページリロード時の設定復元

```
前提条件: localStorage に theme='light' が保存済み
1. ユーザーがページをリロード
2. テーマ初期化スクリプトが<head>内で即座に実行
3. localStorage.getItem('theme') が 'light' を返す
4. <html>に'dark'クラスを追加しない
5. フラッシュなしでライトモード表示
```

### 🟡 エッジケース（黄信号: 一般的なダークモード実装から推測）

#### EDGE-001: localStorageが利用不可能な場合

```
前提条件: プライベートブラウジング等でlocalStorageが制限
1. localStorage.getItem('theme') が例外をスロー、または null を返す
2. デフォルトのダークモードを適用
3. テーマ切り替え機能は動作するが、設定は永続化されない
```

#### EDGE-002: JavaScriptが無効な場合

```
前提条件: JavaScriptが無効
1. テーマ初期化スクリプトが実行されない
2. <html>タグにはクラスがない状態
3. CSSのデフォルトスタイル（ライトモード）で表示
4. ThemeToggleボタンは表示されるが動作しない
```

**注意**: JavaScript無効時はダークモードがデフォルトにならないが、ページは正常に表示される

### 🟡 エラーケース（黄信号: 一般的なエラー処理から推測）

#### ERROR-001: localStorage書き込みエラー

```
シナリオ: ストレージクォータ超過等でlocalStorage.setItemが失敗
対応:
1. try-catchでエラーをキャッチ
2. コンソールに警告を出力
3. テーマ切り替え自体は正常に動作（UIは更新される）
4. 永続化のみ失敗（次回訪問時はデフォルトテーマ）
```

**参照したEARS要件**: tech-stack.md（ダークモード実装方針）
**参照した設計文書**: タスクノート（ThemeToggle.astro設計仕様）

---

## 5. EARS要件・設計文書との対応関係

### 参照したユーザストーリー

- なし（ダークモード機能はtech-stack.mdで直接定義）

### 参照した機能要件

- なし（非機能要件として定義）

### 参照した非機能要件

| 要件ID | 要件内容 | 対応方法 |
|--------|---------|---------|
| NFR-001 | Lighthouse 90+点維持 | 最小限のJS、インラインスクリプト使用 |
| NFR-302 | キーボードナビゲーション対応 | `<button>`要素、Tab/Enter/Space対応 |
| NFR-303 | ARIAラベル設定 | `aria-label="テーマを切り替える"` |
| NFR-304 | フォーカス可視化 | `focus-visible:ring-2`スタイル適用 |

### 参照したEdgeケース

- EDGE-001（要件定義書より）: localStorage利用不可時の対応
- EDGE-002（推測）: JavaScript無効時の対応

### 参照した受け入れ基準

- Lighthouse Accessibility 90+点（NFR-001より）
- キーボードのみでテーマ切り替え可能（NFR-302より）

### 参照した設計文書

| 文書 | 該当セクション | 参照内容 |
|------|--------------|---------|
| tech-stack.md | デザインシステム | ダークモード実装方針、Tailwind設定 |
| tech-stack.md | ダークモード実装方針 | localStorage永続化、フラッシュ防止 |
| architecture.md | ディレクトリ構造 | ThemeToggle.astroの配置場所 |
| タスクノート | ThemeToggle.astro設計仕様 | コンポーネント実装詳細 |
| タスクノート | テーマ初期化スクリプト | BaseLayout.astroへの追加内容 |

---

## 6. 実装対象ファイル

### 新規作成ファイル

| ファイルパス | 説明 |
|-------------|------|
| `src/components/ThemeToggle.astro` | テーマ切り替えボタンコンポーネント |
| `src/components/ThemeToggle.test.ts` | ThemeToggleの単体テスト |

### 変更対象ファイル

| ファイルパス | 変更内容 |
|-------------|---------|
| `src/layouts/BaseLayout.astro` | テーマ初期化インラインスクリプト追加 |
| `src/components/Header.astro` | ThemeToggleコンポーネントのインポート・配置 |

---

## 7. テスト要件

### 🔵 必須テストケース（青信号: タスクノートより）

#### ThemeToggle.astro テスト

| テストカテゴリ | テストケース | 期待結果 |
|--------------|------------|---------|
| 正常系 | コンポーネントがレンダリングされる | `<button>`要素が存在 |
| 正常系 | ボタンにaria-labelが設定されている | `aria-label="テーマを切り替える"` |
| 正常系 | ダーク/ライト両方のアイコンが存在する | 2つのSVG要素が存在 |
| 正常系 | ダークモード用アイコンに`dark:block`クラス | クラスが適用されている |
| 正常系 | ライトモード用アイコンに`block dark:hidden`クラス | クラスが適用されている |
| アクセシビリティ | フォーカス可視化スタイルが適用されている | `focus-visible:ring-2`クラスが存在 |
| アクセシビリティ | ボタンがフォーカス可能 | `tabindex`が-1でない |

#### BaseLayout.astro テスト（テーマ初期化）

| テストカテゴリ | テストケース | 期待結果 |
|--------------|------------|---------|
| 正常系 | テーマ初期化スクリプトが`<head>`内に存在 | `<script is:inline>`が存在 |
| 正常系 | スクリプトにlocalStorage参照が含まれる | `localStorage.getItem('theme')`コードが存在 |

### 🟡 推奨テストケース（黄信号: 一般的なテスト方針から推測）

| テストカテゴリ | テストケース | 期待結果 |
|--------------|------------|---------|
| スタイリング | ホバースタイルが適用されている | `hover:bg-gray-200`クラスが存在 |
| スタイリング | ダークモードホバースタイルが適用されている | `dark:hover:bg-gray-700`クラスが存在 |

---

## 8. 成功基準

### 🔵 機能要件の成功基準（青信号: タスクノート・tech-stack.mdより）

- [ ] ThemeToggleコンポーネントが実装されている
- [ ] クリックでダーク/ライトモードが切り替わる
- [ ] 設定がlocalStorageに保存される
- [ ] ページリロード後も設定が維持される
- [ ] デフォルトでダークモードが適用される
- [ ] テーマ切り替え時にフラッシュが発生しない

### 🔵 非機能要件の成功基準（青信号: NFR要件より）

- [ ] WCAG 2.1 AA準拠（キーボードナビゲーション、ARIA、フォーカス可視化）
- [ ] Lighthouse 90+点維持
- [ ] TypeScript strict mode準拠
- [ ] Biome（リント・フォーマット）準拠

### 🔵 品質基準（青信号: タスクノートより）

- [ ] `pnpm astro check` がエラーなく通る
- [ ] `pnpm test` がエラーなく通る
- [ ] `pnpm lint` がエラーなく通る
- [ ] コードに適切なコメント・JSDocが記載されている
- [ ] 要件トレーサビリティ（関連要件がコメントに記載されている）

---

## 9. 信頼性レベルサマリー

### 信頼性分布

| レベル | 件数 | 割合 | 説明 |
|--------|------|------|------|
| 🔵 青信号 | 45項目 | 90% | tech-stack.md・タスクノート・設計文書から確実に導出 |
| 🟡 黄信号 | 5項目 | 10% | 一般的な実装パターンからの妥当な推測 |
| 🔴 赤信号 | 0項目 | 0% | 根拠のない推測なし |

### 品質評価

**評価**: ✅ 高品質

**評価理由**:
- tech-stack.mdにダークモード実装方針が詳細に記載されており、大部分の仕様が確定
- タスクノートに実装詳細（コード例含む）が記載されており、実装可能性が高い
- 黄信号項目はエッジケース・エラー処理のみで、コア機能には影響なし
- EARS要件定義書の非機能要件（NFR-001, NFR-302～304）が明確に対応付けられている

---

## 10. 参考資料

### 関連ドキュメント

| ドキュメント | パス | 参照内容 |
|------------|------|---------|
| 技術スタック定義 | `docs/tech-stack.md` | ダークモード実装方針 |
| タスクノート | `docs/implements/blog-article-management/TASK-0005/note.md` | 実装詳細・コード例 |
| 要件定義書 | `docs/spec/blog-article-management/requirements.md` | NFR要件 |
| アーキテクチャ設計 | `docs/design/blog-article-management/architecture.md` | コンポーネント構成 |
| BaseLayout.astro | `src/layouts/BaseLayout.astro` | 変更対象ファイル |
| Header.astro | `src/components/Header.astro` | ThemeToggle配置先 |

---

**最終更新日**: 2025-12-31
**作成者**: Claude Opus 4.5 (TDD開発エージェント)
