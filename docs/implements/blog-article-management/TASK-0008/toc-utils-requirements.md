# 目次生成ユーティリティ 要件定義書

**作成日**: 2026-01-01
**タスクID**: TASK-0008
**関連要件**: REQ-901 (目次自動生成)

## 1. 概要

### 1.1 目的

ブログ記事の見出し（h2, h3）から目次を自動生成し、記事詳細ページに表示する。
読者が記事の構造を把握し、目的のセクションに素早くアクセスできるようにする。

### 1.2 関連要件

- **REQ-901**: システムは、記事の見出し（h2, h3）から目次を自動生成しなければならない 🔵
  - 階層構造を維持（h2 > h3）
  - 見出しへのアンカーリンク付き
  - スクロールに応じて現在位置をハイライト

- **REQ-112**: 記事詳細ページで目次を表示（h2, h3見出しから自動生成）

- **EDGE-104**: 見出しが存在しない記事は、目次を表示しないようにしなければならない 🟡

## 2. 機能要件

### 2.1 入力仕様

Astroの`render()`メソッドが返す`headings`配列を入力として受け取る:

```typescript
interface MarkdownHeading {
  depth: number;  // 見出しレベル (1-6)
  slug: string;   // アンカーID
  text: string;   // 見出しテキスト
}
```

### 2.2 出力仕様

目次データ構造を出力:

```typescript
interface TOCItem {
  depth: number;     // 見出しレベル (2 or 3)
  slug: string;      // アンカーリンク用ID
  text: string;      // 見出しテキスト
  children: TOCItem[]; // 子項目（h3がh2の下に配置）
}

interface TOCResult {
  items: TOCItem[];  // トップレベルの目次項目
  hasContent: boolean; // 目次があるか
}
```

### 2.3 機能仕様

| 機能ID | 機能名 | 説明 | 信頼性 |
|--------|--------|------|--------|
| TOC-001 | h2/h3抽出 | headings配列からh2, h3のみを抽出する | 🔵 |
| TOC-002 | 階層構造生成 | h2をトップレベル、h3を子項目として階層化 | 🔵 |
| TOC-003 | アンカーリンク生成 | slug値をそのまま使用してアンカーリンクを提供 | 🔵 |
| TOC-004 | 空目次判定 | 見出しが存在しない場合を判定可能にする | 🔵 |

## 3. エッジケース

### 3.1 空の入力

- **EDGE-TOC-001**: headingsが空配列の場合、`hasContent: false`を返す
- **EDGE-TOC-002**: h2/h3が存在しない場合、`hasContent: false`を返す

### 3.2 h3のみの場合

- **EDGE-TOC-003**: h3のみで始まる場合、h3をトップレベルとして扱う
  - 親h2がないh3は独立した項目として扱う

### 3.3 特殊文字

- **EDGE-TOC-004**: テキストに特殊文字が含まれる場合もそのまま保持
  - HTMLエスケープはコンポーネント側で行う

## 4. パフォーマンス要件

- **PERF-001**: O(n)の時間計算量で処理（nは見出し数）
- **PERF-002**: 外部ライブラリ不使用（Lighthouse 90+維持）

## 5. テスト戦略

### 5.1 単体テスト

- 正常系: 標準的なh2/h3構造の変換
- 異常系: 空配列、h1のみ、h4-h6のみ
- 境界値: h3のみ、h2のみ、深いネスト

### 5.2 テストデータ

```typescript
// 標準的な入力
const standardHeadings = [
  { depth: 2, slug: 'section-1', text: 'セクション1' },
  { depth: 3, slug: 'subsection-1-1', text: 'サブセクション1.1' },
  { depth: 2, slug: 'section-2', text: 'セクション2' },
];
```

## 6. 関連文書

- [テストケース定義書](./toc-utils-testcases.md)
- [アーキテクチャ設計](../../../design/blog-article-management/architecture.md)
- [データフロー](../../../design/blog-article-management/dataflow.md)

## 7. 信頼性レベルサマリー

- 🔵 青信号: 4件 (100%)
- 🟡 黄信号: 0件 (0%)
- 🔴 赤信号: 0件 (0%)

**品質評価**: 高品質 - 要件定義書REQ-901から明確に導出可能
