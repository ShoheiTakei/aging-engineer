# ブログ記事管理機能 要件定義書

## 概要

Astro.jsブログプロジェクトのコア機能として、Markdown形式の記事をGitで管理し、静的サイトとして公開するブログ記事管理機能を実装する。Content Collections APIを使用した型安全なコンテンツ管理、Cloudflare R2での画像管理、ページネーション、タグ機能、検索機能、RSS Feed、関連記事表示などの包括的な機能を提供する。

**プロジェクト特性**:
- **執筆環境**: Vimでローカル執筆、Git管理
- **コンテンツ形式**: Markdown（frontmatter + 本文）
- **デプロイフロー**: Git push → Cloudflare Pages自動ビルド・公開
- **パフォーマンス**: Lighthouse 90+点維持
- **アクセシビリティ**: WCAG 2.1 AA準拠

## 関連文書

- **ヒアリング記録**: [💬 interview-record.md](interview-record.md)
- **ユーザストーリー**: [📖 user-stories.md](user-stories.md)
- **受け入れ基準**: [✅ acceptance-criteria.md](acceptance-criteria.md)
- **技術スタック定義**: [../../tech-stack.md](../../tech-stack.md)
- **フロントエンドテスト基盤**: [../../design/frontend-test-infra/](../../design/frontend-test-infra/)

## 機能要件（EARS記法）

**【信頼性レベル凡例】**:
- 🔵 **青信号**: PRD・EARS要件定義書・設計文書・ユーザヒアリングを参考にした確実な要件
- 🟡 **黄信号**: PRD・EARS要件定義書・設計文書・ユーザヒアリングから妥当な推測による要件
- 🔴 **赤信号**: PRD・EARS要件定義書・設計文書・ユーザヒアリングにない推測による要件

### 1. 記事作成・管理（CRUD操作）

#### 通常要件

- **REQ-001**: システムは、Markdown形式（`.md`ファイル）で記事を作成できなければならない 🔵 *tech-stack.md、ユーザヒアリングより*
- **REQ-002**: システムは、Content Collections API（`src/content/blog/*.md`）を使用して記事を管理しなければならない 🔵 *tech-stack.md・既存設計より*
- **REQ-003**: システムは、frontmatterで以下のメタデータを管理しなければならない 🔵 *tech-stack.md、ユーザヒアリングより*
  - `title`: 記事タイトル（必須、文字列）
  - `description`: 記事の説明（必須、文字列）
  - `pubDate`: 公開日時（必須、日付）
  - `updatedDate`: 更新日時（任意、日付）
  - `coverImage`: カバー画像URL（任意、文字列、Cloudflare R2のURL）
  - `tags`: タグ配列（任意、文字列配列）
  - `draft`: 下書きフラグ（任意、真偽値、デフォルト: false）

- **REQ-004**: システムは、Gitでバージョン管理された記事を自動的に検出し、ビルド時に静的HTMLを生成しなければならない 🔵 *tech-stack.md・デプロイフローより*
- **REQ-005**: システムは、Markdownの本文をHTMLに変換し、スタイリングを適用して表示しなければならない 🔵 *tech-stack.md・ワークフローより*

#### 更新・削除

- **REQ-010**: システムは、既存のMarkdownファイルを編集することで記事を更新できなければならない 🔵 *ユーザヒアリングより*
- **REQ-011**: システムは、Markdownファイルを削除し、再デプロイすることで記事を削除できなければならない 🔵 *ユーザヒアリングより*

### 2. 記事表示

#### 記事一覧ページ

- **REQ-101**: システムは、ブログ記事一覧ページ（`/blog/`）を提供しなければならない 🔵 *tech-stack.md推奨ディレクトリ構造より*
- **REQ-102**: システムは、記事一覧で以下の情報を表示しなければならない 🔵 *ユーザヒアリングより*
  - タイトル
  - 説明文
  - 公開日
  - タグ一覧
  - カバー画像（設定されている場合）
  - 読了時間

- **REQ-103**: システムは、記事一覧を公開日の新しい順（降順）で表示しなければならない 🔵 *ユーザヒアリング Q12より*

#### 記事詳細ページ

- **REQ-110**: システムは、個別記事詳細ページ（`/blog/[slug]/`）を提供しなければならない 🔵 *tech-stack.md推奨ディレクトリ構造より*
- **REQ-111**: システムは、Markdownコードブロックにシンタックスハイライトを適用しなければならない 🔵 *ユーザヒアリング Q18より*
  - Shiki（Astro標準）を使用
  - 主要なプログラミング言語をサポート

- **REQ-112**: システムは、記事詳細ページで以下の情報を表示しなければならない 🔵 *ユーザヒアリングより*
  - タイトル
  - 公開日・更新日
  - タグ一覧
  - 読了時間
  - 目次（h2, h3見出しから自動生成）
  - 本文（HTML変換後）
  - 関連記事リスト

### 3. ページネーション

- **REQ-201**: システムは、記事一覧ページにページネーション機能を提供しなければならない 🔵 *ユーザヒアリング Q1より*
  - 1ページあたり5件表示
  - ページ番号表示
  - 前へ・次へボタン
  - 現在のページ番号をハイライト

- **REQ-202**: システムは、記事のソート順序を変更できなければならない 🔵 *ユーザヒアリング Q12より*
  - デフォルト: 新しい順（降順）
  - 古い順（昇順）も選択可能

### 4. タグ機能

- **REQ-301**: システムは、記事にタグを付与できなければならない 🔵 *tech-stack.md、ユーザヒアリング Q2より*
- **REQ-302**: システムは、タグ一覧ページ（`/tags/`）を提供しなければならない 🔵 *ユーザヒアリング Q2より*
  - 全タグのリスト表示
  - 各タグの記事数表示

- **REQ-303**: システムは、タグ別記事一覧ページ（`/tags/[tag]/`）を提供しなければならない 🔵 *ユーザヒアリング Q2より*
  - 特定タグが付与された記事のみ表示
  - ページネーション対応

### 5. 下書き機能

- **REQ-501**: システムは、`draft: true`が設定された記事を本番環境で非表示にしなければならない 🔵 *ユーザヒアリング Q4より*
- **REQ-502**: システムは、開発環境（`pnpm dev`）で下書き記事も表示しなければならない 🔵 *ユーザヒアリング Q4より*

### 6. 記事検索

- **REQ-401**: システムは、記事検索機能を提供しなければならない 🔵 *ユーザヒアリング Q3より*
  - タイトルと本文から全文検索
  - 部分一致検索をサポート
  - 検索結果をハイライト表示

- **REQ-402**: システムは、検索結果を関連度順に表示しなければならない 🔵 *ユーザヒアリング Q3より*

### 7. RSS Feed

- **REQ-601**: システムは、RSS 2.0フィード（`/rss.xml`）を生成しなければならない 🔵 *tech-stack.md、ユーザヒアリング Q5より*
  - 最新20件の記事を含む
  - タイトル、説明、公開日、リンクを含む
  - 自動更新（ビルド時に再生成）

### 8. 関連記事表示

- **REQ-701**: システムは、記事詳細ページに関連記事リストを表示しなければならない 🔵 *ユーザヒアリング Q6より*
  - タグが一致する記事を優先表示
  - 最大5件まで表示
  - 現在の記事を除外

### 9. 読了時間表示

- **REQ-801**: システムは、記事の読了時間を自動計算して表示しなければならない 🔵 *ユーザヒアリング Q9より*
  - 日本語: 500文字/分で計算
  - 分単位で表示（例: "約3分で読めます"）

### 10. 目次自動生成

- **REQ-901**: システムは、記事の見出し（h2, h3）から目次を自動生成しなければならない 🔵 *ユーザヒアリング Q10より*
  - 階層構造を維持（h2 > h3）
  - 見出しへのアンカーリンク付き
  - スクロールに応じて現在位置をハイライト

## 非機能要件

### パフォーマンス

- **NFR-001**: 記事詳細ページはLighthouse 90+点を維持しなければならない 🔵 *tech-stack.md品質基準、ユーザヒアリング Q13より*
  - Performance: 90+
  - Accessibility: 90+
  - Best Practices: 90+
  - SEO: 90+

- **NFR-002**: 記事一覧ページの初期表示は3秒以内に完了しなければならない 🔵 *tech-stack.mdパフォーマンス要件より*

### SEO

- **NFR-101**: 記事詳細ページは適切なメタタグを設定しなければならない 🔵 *tech-stack.md品質基準、ユーザヒアリング Q14より*
  - `<title>`: 記事タイトル
  - `<meta name="description">`: 記事説明
  - `<meta name="keywords">`: タグ一覧

- **NFR-102**: システムはOGP（Open Graph Protocol）メタタグを設定しなければならない 🔵 *ユーザヒアリング Q14より*
  - `og:title`: 記事タイトル
  - `og:description`: 記事説明
  - `og:type`: article
  - `og:url`: 記事URL
  - ※OGP画像（`og:image`）は不要（ユーザヒアリング Q7より）

- **NFR-103**: システムはサイトマップ（`/sitemap.xml`）を自動生成しなければならない 🔵 *tech-stack.md、ユーザヒアリング Q14より*
  - 全記事のURLを含む
  - 更新頻度・優先度を設定

- **NFR-104**: システムは構造化データ（JSON-LD）を埋め込まなければならない 🔵 *ユーザヒアリング Q14より*
  - `@type`: BlogPosting
  - headline, datePublished, dateModified, author等を含む

### 画像最適化

- **NFR-201**: システムはCloudflare R2から画像を配信しなければならない 🔵 *tech-stack.md、ユーザヒアリング Q15より*
- **NFR-202**: システムはAstro Imageコンポーネントを使用して画像を最適化しなければならない 🔵 *ユーザヒアリング Q15より*
  - WebP/AVIF形式に自動変換
  - レスポンシブ対応（srcset生成）
  - 遅延読み込み（lazy loading）

- **NFR-203**: カバー画像は1200x630px（16:9比率推奨）で提供されなければならない 🟡 *一般的なOGP画像サイズから推測*

### アクセシビリティ

- **NFR-301**: システムはセマンティックHTMLを使用しなければならない 🔵 *tech-stack.md品質基準、ユーザヒアリング Q16より*
  - `<article>`, `<header>`, `<nav>`, `<main>`, `<footer>`を適切に使用

- **NFR-302**: システムはキーボードナビゲーションをサポートしなければならない 🔵 *ユーザヒアリング Q16より*
  - Tab, Enter, Spaceキーで操作可能

- **NFR-303**: システムはARIAラベルを適切に設定しなければならない 🔵 *ユーザヒアリング Q16より*
  - リンク、ボタン、ナビゲーション要素にaria-label付与

- **NFR-304**: 画像には代替テキスト（alt属性）を必ず設定しなければならない 🔵 *ユーザヒアリング Q16より*

## Edgeケース

### エラー処理

- **EDGE-001**: 記事が存在しない場合、「記事がありません」メッセージを表示しなければならない 🔵 *ユーザヒアリング Q17より*
- **EDGE-002**: 無効なslug（存在しない記事URL）にアクセスした場合、404ページを表示しなければならない 🟡 *一般的なWebアプリケーションの慣習より*
- **EDGE-003**: Cloudflare R2の画像が読み込めない場合、代替テキストを表示し、レイアウトを崩さないようにしなければならない 🟡 *一般的な画像エラー処理より*

### 境界値

- **EDGE-101**: タグが設定されていない記事は、タグなしとして表示しなければならない 🔵 *tech-stack.md・frontmatter仕様より*
- **EDGE-102**: カバー画像が設定されていない記事は、デフォルト画像またはテキストのみで表示しなければならない 🟡 *一般的なブログUIパターンより*
- **EDGE-103**: 読了時間が1分未満の記事は、「1分未満」と表示しなければならない 🟡 *ユーザビリティの観点から推測*
- **EDGE-104**: 見出しが存在しない記事は、目次を表示しないようにしなければならない 🟡 *一般的な目次機能の仕様より*

### データ制約

- **EDGE-201**: 記事タイトルは100文字以内に制限しなければならない 🟡 *SEO・UIベストプラクティスより*
- **EDGE-202**: 記事説明は200文字以内に制限しなければならない 🟡 *SEO・UIベストプラクティスより*
- **EDGE-203**: タグ名は30文字以内に制限しなければならない 🟡 *UI表示の観点から推測*
- **EDGE-204**: 1記事あたりのタグ数は10個以内に制限することを推奨する 🟡 *一般的なタグ管理のベストプラクティスより*

## 制約要件

- **REQ-901**: システムは静的サイト生成（SSG）のみをサポートし、サーバーサイドレンダリング（SSR）は使用しない 🔵 *tech-stack.md・Astro設定より*
- **REQ-902**: 記事の作成・編集・削除は、ローカル環境でのファイル操作とGit pushによってのみ行う 🔵 *tech-stack.md・ワークフローより*
- **REQ-903**: 画像はCloudflare R2にアップロードし、Markdown内ではR2のURLを参照する 🔵 *tech-stack.md・画像管理方針より*
- **REQ-904**: ビルドはCloudflare Pagesで自動実行され、手動ビルドは開発環境のみで行う 🔵 *tech-stack.md・デプロイフローより*

## 信頼性レベル分布

**全要件（機能要件 + 非機能要件 + Edgeケース）**:
- 🔵 青信号: 45件 (75%)
- 🟡 黄信号: 15件 (25%)
- 🔴 赤信号: 0件 (0%)

**品質評価**: ✅ 高品質 - ユーザヒアリングにより大部分の要件が確定、推測部分も妥当な根拠あり
