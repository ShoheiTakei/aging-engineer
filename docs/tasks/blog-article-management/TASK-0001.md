# TASK-0001: Content Collections設定とスキーマ定義

**作成日**: 2025-12-29
**タスクタイプ**: DIRECT
**見積もり工数**: 4時間
**優先度**: P0 (最優先 - すべてのタスクの基盤)
**実装者**: TBD
**レビュアー**: TBD

## 概要

Astro Content Collections APIを使用してブログ記事のスキーマを定義し、型安全なコンテンツ管理の基盤を構築します。

**関連要件**: REQ-001~REQ-011, REQ-301, REQ-501
**関連設計**: [architecture.md](../../design/blog-article-management/architecture.md), [interfaces.ts](../../design/blog-article-management/interfaces.ts)

## 🎯 達成目標

- [x] Content Collectionsの設定ファイル作成
- [x] Zodスキーマによる型定義
- [x] サンプルMarkdown記事の作成と検証
- [x] TypeScript型推論の動作確認

## 📋 実装ステップ

### Step 1: ディレクトリ構造の作成 🔵

**信頼性**: 🔵 *architecture.md・tech-stack.mdより*

```bash
mkdir -p src/content/blog
touch src/content/config.ts
```

**成功基準**:
- ✅ `src/content/blog/` ディレクトリが存在する
- ✅ `src/content/config.ts` ファイルが存在する

---

### Step 2: Content Collections設定ファイルの実装 🔵

**信頼性**: 🔵 *architecture.md・interfaces.tsより*

**ファイル**: `src/content/config.ts`

```typescript
import { defineCollection, z } from 'astro:content';

/**
 * ブログ記事コレクション定義
 * 🔵 信頼性: architecture.md・interfaces.tsより
 */
const blogCollection = defineCollection({
  type: 'content',
  schema: z.object({
    // REQ-001: 必須フィールド
    title: z.string().min(1, 'タイトルは必須です'),
    description: z.string().min(1, '説明は必須です'),
    pubDate: z.date(),

    // REQ-001: 任意フィールド
    updatedDate: z.date().optional(),
    coverImage: z.string().url().optional(),

    // REQ-301: タグ機能
    tags: z.array(z.string()).default([]),

    // REQ-501: 下書き機能
    draft: z.boolean().default(false),
  }),
});

export const collections = {
  blog: blogCollection,
};
```

**実装時の注意点**:
- Zodバリデーションでランタイム型チェックを実施
- デフォルト値は明示的に設定（空配列、false等）
- URL検証は`.url()`を使用
- 最小長バリデーションでデータ品質を保証

**成功基準**:
- ✅ TypeScriptコンパイルエラーがない
- ✅ Zodスキーマが正しく定義されている
- ✅ すべてのREQ要件がカバーされている

---

### Step 3: サンプルMarkdown記事の作成 🔵

**信頼性**: 🔵 *architecture.md・要件定義書より*

**ファイル**: `src/content/blog/sample-post.md`

```markdown
---
title: "サンプル記事 - Astro Content Collections"
description: "Content Collections APIの動作確認用サンプル記事です"
pubDate: 2025-01-15
updatedDate: 2025-01-16
coverImage: "https://example.com/cover.jpg"
tags: ["Astro", "TypeScript", "Content Collections"]
draft: false
---

# サンプル記事

これはContent Collections APIの動作確認用サンプル記事です。

## セクション1

本文の内容がここに入ります。

## セクション2

追加の内容がここに入ります。

```typescript
// コードブロックのテスト
console.log('Hello, Astro!');
```
```

**成功基準**:
- ✅ frontmatterがスキーマに適合している
- ✅ Markdown本文が正しくレンダリングされる
- ✅ 型推論が正しく機能する

---

### Step 4: 型推論と動作確認 🔵

**信頼性**: 🔵 *architecture.md・interfaces.tsより*

**確認用コード**: `src/pages/sample.astro`

```astro
---
import { getCollection } from 'astro:content';

// 型推論の動作確認
const allPosts = await getCollection('blog');

// TypeScriptによる型チェック
allPosts.forEach((post) => {
  const title: string = post.data.title; // ✅ 型安全
  const tags: string[] = post.data.tags; // ✅ 型安全
  const draft: boolean = post.data.draft; // ✅ 型安全
});
---

<h1>Content Collections 動作確認</h1>
<ul>
  {allPosts.map((post) => (
    <li>{post.data.title} - {post.data.tags.join(', ')}</li>
  ))}
</ul>
```

**成功基準**:
- ✅ `getCollection('blog')` がエラーなく動作する
- ✅ TypeScript型推論が正しく機能する
- ✅ `pnpm astro check` がエラーなく通る
- ✅ `pnpm dev` でページが正しく表示される

---

## 🧪 テスト要件

### 単体テスト

**ファイル**: `src/content/config.test.ts` (テスト基盤整備後に実装)

```typescript
import { describe, it, expect } from 'vitest';
import { z } from 'zod';

describe('Content Collections Schema', () => {
  it('正しいfrontmatterを受け入れる', () => {
    const schema = z.object({
      title: z.string().min(1),
      description: z.string().min(1),
      pubDate: z.date(),
      tags: z.array(z.string()).default([]),
      draft: z.boolean().default(false),
    });

    const validData = {
      title: 'Test Post',
      description: 'Test Description',
      pubDate: new Date('2025-01-15'),
      tags: ['test'],
      draft: false,
    };

    expect(() => schema.parse(validData)).not.toThrow();
  });

  it('不正なfrontmatterを拒否する', () => {
    const schema = z.object({
      title: z.string().min(1),
      description: z.string().min(1),
      pubDate: z.date(),
    });

    const invalidData = {
      title: '', // 空文字列は不可
      description: 'Test',
      pubDate: new Date(),
    };

    expect(() => schema.parse(invalidData)).toThrow();
  });
});
```

**テストケース**:
- [ ] TC-001-01: 正常なfrontmatterで型推論が成功する
- [ ] TC-001-02: 必須フィールド欠如でバリデーションエラーが発生する
- [ ] TC-001-03: 不正なURL形式でバリデーションエラーが発生する
- [ ] TC-001-04: デフォルト値が正しく適用される（tags: [], draft: false）

### 動作確認テスト

**手動確認**:
1. `pnpm dev` でサーバー起動
2. `/sample` ページにアクセス
3. サンプル記事が表示されることを確認
4. `pnpm astro check` で型エラーがないことを確認

---

## 🎨 UI/UX要件

このタスクはバックエンド設定のため、UI/UX要件はありません。

---

## 📦 依存関係

### 前提タスク

なし（最初のタスク）

### 後続タスク

- TASK-0002: ディレクトリ構造とプロジェクト初期化
- TASK-0003: 基本レイアウトの実装
- すべてのコンテンツ取得を行うタスク

---

## 🔧 技術仕様

### 使用技術

- **Astro Content Collections API** 🔵 *architecture.mdより*
- **Zod 3.x** 🔵 *既存依存関係より*
- **TypeScript 5.7+** 🔵 *tech-stack.mdより*

### ディレクトリ構成

```
src/
└── content/
    ├── config.ts          # Content Collections設定
    └── blog/              # Markdown記事ディレクトリ
        └── sample-post.md # サンプル記事
```

### 設定ファイル

**`astro.config.mjs`** には追加設定不要（Content Collections APIはデフォルトで有効）

---

## 📝 実装時の注意事項

### スキーマ設計の注意点 🔵

**信頼性**: 🔵 *architecture.md・セキュリティ設計より*

1. **バリデーション必須**:
   - `title`, `description` は `.min(1)` で空文字列を防ぐ
   - `coverImage` は `.url()` でURL形式を検証

2. **デフォルト値の明示**:
   - `tags: z.array(z.string()).default([])` - 空配列
   - `draft: z.boolean().default(false)` - 公開状態

3. **型安全性**:
   - Zodスキーマから自動的にTypeScript型が生成される
   - `getCollection()` の戻り値で型推論が効く

### パフォーマンス考慮事項 🟡

**信頼性**: 🟡 *NFR-001から妥当な推測*

- Content Collectionsはビルド時に処理されるため、ランタイムパフォーマンスへの影響なし
- スキーマバリデーションはビルド時のみ実行される

---

## ✅ 完了条件

### 必須条件

- [x] `src/content/config.ts` が実装されている
- [x] Zodスキーマがすべてのfrontmatterフィールドを定義している
- [x] サンプル記事が正しく読み込まれる
- [x] `pnpm astro check` がエラーなく通る
- [x] TypeScript型推論が正しく機能する

### 品質基準

- [x] コードに型エラーがない
- [x] Zodバリデーションが正しく動作する
- [x] ドキュメントコメントが記載されている

---

## 🔄 レビューポイント

### コードレビュー観点

1. **スキーマの完全性**: すべてのREQ要件がカバーされているか
2. **バリデーションの妥当性**: `.min(1)`, `.url()` 等が適切か
3. **デフォルト値**: `tags`, `draft` のデフォルト値が正しいか
4. **型安全性**: TypeScript型推論が正しく機能するか

### テストレビュー観点

1. **バリデーションテスト**: 正常系・異常系が網羅されているか
2. **型推論テスト**: 型エラーが発生しないか

---

## 📚 参考資料

- [Astro Content Collections 公式ドキュメント](https://docs.astro.build/ja/guides/content-collections/)
- [Zod 公式ドキュメント](https://zod.dev/)
- **プロジェクト内設計書**:
  - `docs/design/blog-article-management/architecture.md`
  - `docs/design/blog-article-management/interfaces.ts`
  - `docs/spec/blog-article-management/requirements.md`

---

## 🏷️ タグ・ラベル

`infrastructure`, `content-collections`, `schema`, `typescript`, `p0`

---

## 📊 進捗管理

- **ステータス**: ✅ Completed
- **開始日**: 2025-12-30
- **完了日**: 2025-12-30
- **実績工数**: 0.5時間（見積もり: 4時間）

---

**信頼性レベルサマリー**:
- 🔵 青信号: 95% (設計文書から確実)
- 🟡 黄信号: 5% (パフォーマンス考慮事項)
- 🔴 赤信号: 0%
